<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Notas - Contemporâneo Centro Educacional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
            overflow-y: auto;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .active-tab {
            /* Estilo do anel para o botão ativo */
            ring: 4px;
            ring-offset: 2px;
            --tw-ring-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 4px var(--tw-ring-color);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a34a; /* green-500 */
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="bg-green-700 text-white p-6 rounded-xl shadow-lg mb-8 text-center">
            <h1 class="text-2xl md:text-4xl font-bold">Contemporâneo Centro Educacional</h1>
            <p class="text-md text-green-100 mt-2">Sistema de Gerenciamento de Notas dos Alunos</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-md mb-8">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">Selecione a Turma</h2>
                    <div id="class-tabs" class="flex flex-wrap gap-3"></div>
                </div>
                <div class="flex-grow md:max-w-xs">
                     <h2 class="text-lg font-semibold text-gray-700 mb-3">Buscar Aluno</h2>
                    <input type="text" id="search-input" placeholder="Digite o nome do aluno..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition">
                </div>
            </div>
        </div>

        <main class="bg-white p-4 sm:p-6 rounded-xl shadow-md overflow-x-auto">
             <h2 id="class-title" class="text-2xl font-bold text-gray-800 mb-4">Selecione uma turma para começar</h2>
            <table class="w-full text-left">
                <thead class="border-b-2 border-gray-200">
                    <tr>
                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider">Aluno</th>
                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-center">Média Final</th>
                        <th class="p-4 text-sm font-semibold text-gray-600 uppercase tracking-wider text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="student-list">
                     <tr><td colspan="3" class="text-center p-8 text-gray-500">Nenhuma turma selecionada.</td></tr>
                </tbody>
            </table>
        </main>
    </div>

    <!-- Modals -->
    <div id="edit-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl modal-content transform scale-95">
             <div class="p-6 border-b bg-green-600 text-white rounded-t-xl">
                <h2 class="text-2xl font-bold">Editar Notas</h2>
                <p id="edit-student-name" class="text-md text-green-100"></p>
            </div>
            <div id="edit-form-content" class="p-6 space-y-4 max-h-[60vh] overflow-y-auto"></div>
            <div class="p-6 bg-gray-50 rounded-b-xl flex justify-end items-center gap-4">
                <button id="close-edit-modal-btn" class="text-gray-600 font-semibold px-4 py-2 rounded-lg hover:bg-gray-200 transition">Cancelar</button>
                <button id="save-grades-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition shadow">Salvar Alterações</button>
            </div>
        </div>
    </div>
    <div id="report-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden opacity-0">
        <div class="bg-white w-full max-w-2xl rounded-xl shadow-2xl modal-content transform scale-95">
             <div class="p-6 border-b flex justify-between items-start bg-green-600 text-white rounded-t-xl">
                <h2 class="text-2xl font-bold ">Relatório Pedagógico do Aluno</h2>
                <button id="close-report-modal-btn" class="text-green-100 hover:text-white transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="max-h-[70vh] overflow-y-auto p-6">
                <div id="report-content"></div>
                <div id="qualitative-assessment" class="mt-6 bg-gray-50 p-4 rounded-lg border">
                    <h3 class="font-semibold text-lg text-gray-800 mb-4">Avaliação Qualitativa</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="font-medium text-gray-700">Participação em aula:</label>
                            <div class="flex flex-wrap gap-4 mt-2" id="q1">
                                <label><input type="radio" name="participation" value="Ativa e contribui" class="mr-1"> Ativa</label>
                                <label><input type="radio" name="participation" value="Ocasional" class="mr-1"> Ocasional</label>
                                <label><input type="radio" name="participation" value="Passiva" class="mr-1"> Passiva</label>
                            </div>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Entrega de tarefas:</label>
                            <div class="flex flex-wrap gap-4 mt-2" id="q2">
                                <label><input type="radio" name="homework" value="Sempre no prazo" class="mr-1"> Em dia</label>
                                <label><input type="radio" name="homework" value="Às vezes atrasa" class="mr-1"> Às vezes</label>
                                <label><input type="radio" name="homework" value="Raramente entrega" class="mr-1"> Raramente</label>
                            </div>
                        </div>
                         <div>
                            <label class="font-medium text-gray-700">Comportamento em sala:</label>
                            <div class="flex flex-wrap gap-4 mt-2" id="q3">
                                <label><input type="radio" name="behavior" value="Exemplar" class="mr-1"> Exemplar</label>
                                <label><input type="radio" name="behavior" value="Adequado" class="mr-1"> Adequado</label>
                                <label><input type="radio" name="behavior" value="Requer atenção" class="mr-1"> Requer atenção</label>
                            </div>
                        </div>
                        <div>
                            <label class="font-medium text-gray-700">Interesse pela matéria:</label>
                            <div class="flex flex-wrap gap-4 mt-2" id="q4">
                                <label><input type="radio" name="interest" value="Muito interessado" class="mr-1"> Alto</label>
                                <label><input type="radio" name="interest" value="Interesse mediano" class="mr-1"> Médio</label>
                                <label><input type="radio" name="interest" value="Pouco interessado" class="mr-1"> Baixo</label>
                            </div>
                        </div>
                        <div>
                            <label for="observations" class="font-medium text-gray-700">Observações Adicionais</label>
                            <textarea id="observations" rows="3" class="w-full mt-2 p-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none" placeholder="Digite aqui pontos importantes sobre o aluno..."></textarea>
                        </div>
                    </div>
                </div>
                 <div id="ai-analysis-container" class="mt-6 p-4 bg-green-50 border-l-4 border-green-500 rounded-r-lg" style="display: none;"></div>
            </div>
             <div class="p-6 bg-gray-50 rounded-b-xl flex justify-between items-center">
                 <button id="ai-analysis-btn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition shadow disabled:opacity-50">✨ Gerar Análise com IA</button>
                 <button id="print-report-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition shadow" disabled>Imprimir</button>
            </div>
        </div>
    </div>
    
    <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
        Criado por Kelvin Radimak
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const initialStudentData = {
                "6A": [
                    { id: 101, name: "ALICE MATILDE SANTOS", grades: [null, null, null, { sae: 2.5, prova: 5.0 }, null, null]},
                    { id: 102, name: "ANA CLARA LIMA ARAÚJO BASTOS", grades: [null, null, null, { sae: 2.5, prova: 5.0 }, null, null]},
                    { id: 103, name: "ANTHONY GABRIEL SOUZA MENEZES", grades: [null, null, null, { sae: 3.5, prova: 8.0 }, null, null]},
                    { id: 104, name: "BEATRIZ VIANA DOS SANTOS", grades: [null, null, null, { sae: 1.0, prova: 1.0 }, null, null]},
                    { id: 105, name: "CARLOS RYAN OLIVEIRA BOMFIM DOS SANTOS", grades: [null, null, null, { sae: 1.5, prova: 2.0 }, null, null]},
                    { id: 106, name: "ENZZO SANTANA FEITOSA CAVALCANTE", grades: [null, null, null, { sae: 5.0, prova: 10.0 }, null, null]},
                    { id: 107, name: "JÉSSICA FREIRE DE CARVALHO LEITE", grades: [null, null, null, { sae: 0.0, prova: 3.0 }, null, null]},
                    { id: 108, name: "JOÃO GUILHERME GONÇALVES SANTOS", grades: [null, null, null, { sae: 1.5, prova: 5.5 }, null, null]},
                    { id: 109, name: "JÚLIA CAROLLINY SOUZA ANDRADE", grades: [null, null, null, { sae: 1.0, prova: 4.5 }, null, null]},
                    { id: 110, name: "KETHLYN SOPHYA SANTOS DE OLIVEIRA", grades: [null, null, null, { sae: 0.0, prova: 4.0 }, null, null]},
                    { id: 111, name: "LUCAS EDUARDO DA SILVA COSTA", grades: [null, null, null, { sae: 2.5, prova: 5.0 }, null, null]},
                    { id: 113, name: "PAULA FABIANA NASCIMENTO BARBOSA DÓRIA", grades: [null, null, null, { sae: 1.5, prova: 4.0 }, null, null]},
                    { id: 114, name: "PHILLIPE RAFAEL SANTANA SANTOS", grades: [null, null, null, { sae: 3.5, prova: 5.5 }, null, null]},
                    { id: 115, name: "TONNY NÉO DA ROCHA", grades: [null, null, null, { sae: 4.0, prova: 9.0 }, null, null]}
                ],
                "7A": [
                     { id: 201, name: "ADEMIR JÚNIOR ALMEIDA OLIVEIRA", grades: [null, null, null, { sae: 3.5, prova: 7.0 }, null, null]},
                     { id: 202, name: "ALÍCIA MARIA DE SOUZA BARROS", grades: [null, null, null, { sae: 3.5, prova: null }, null, null]},
                     { id: 203, name: "ANNA JÚLIA DOS SANTOS GONÇALVES", grades: [null, null, null, { sae: 3.5, prova: 7.0 }, null, null]},
                     { id: 204, name: "ANTONNY RAPHAEL CARDOSO DOS SANTOS", grades: [null, null, null, null, null, null]},
                     { id: 205, name: "ARTHUR VALDIR BATISTA DOS SANTOS", grades: [null, null, null, { sae: 1.6, prova: 4.75 }, null, null]},
                     { id: 206, name: "ARTHUR FERREIRA DE SANTANA", grades: [null, null, null, { sae: 1.0, prova: 3.0 }, null, null]},
                     { id: 207, name: "ARTHUR MIGUEL DE SANTANA ARAGÃO", grades: [null, null, null, { sae: 2.5, prova: 9.75 }, null, null]},
                     { id: 208, name: "ARTHUR SILVA OLIVEIRA SANTOS", grades: [null, null, null, { sae: 1.6, prova: 6.5 }, null, null]},
                     { id: 209, name: "AYLA SOFHIA MATEUS DOS SANTOS", grades: [null, null, null, { sae: 1.0, prova: 6.5 }, null, null]},
                     { id: 210, name: "CAIO JOAQUIM BORGES MELO", grades: [null, null, null, { sae: 3.5, prova: 5.0 }, null, null]},
                     { id: 211, name: "CAIO LUCAS DE SANTANA", grades: [null, null, null, { sae: 1.6, prova: 5.0 }, null, null]},
                     { id: 212, name: "CAUÃ VICTOR NOBRE FLORIANO", grades: [null, null, null, { sae: 1.5, prova: 4.5 }, null, null]},
                     { id: 213, name: "CAUÊ SOUZA MATOS FILHO", grades: [null, null, null, { sae: 2.0, prova: 2.5 }, null, null]},
                     { id: 214, name: "GUILHERME FERNANDES SANTOS BARROS", grades: [null, null, null, { sae: 0.0, prova: 10.0 }, null, null]},
                     { id: 215, name: "JEFFERSON CAUÃ RODRIGUES BERNARDES", grades: [null, null, null, { sae: 4.0, prova: 10.0 }, null, null]},
                     { id: 216, name: "JENNIFER LORENA RODRIGUES DOS SANTOS", grades: [null, null, null, { sae: 2.5, prova: 6.75 }, null, null]},
                     { id: 217, name: "JOÃO PEDRO SANTOS ROSA MARTINS", grades: [null, null, null, { sae: 2.5, prova: 8.0 }, null, null]},
                     { id: 218, name: "JÚLIA EXPEDITA SÁ DANTAS", grades: [null, null, null, { sae: 3.0, prova: null }, null, null]},
                     { id: 219, name: "LETÍCIA MERIELEN SANTOS DE AQUINO", grades: [null, null, null, { sae: 1.6, prova: 5.0 }, null, null]},
                     { id: 220, name: "LUIZ GUILHERME DOS SANTOS FONSECA", grades: [null, null, null, { sae: 1.0, prova: 5.75 }, null, null]},
                     { id: 221, name: "MARIA AGATHA SANTOS SILVA", grades: [null, null, null, { sae: 3.5, prova: 5.0 }, null, null]},
                     { id: 222, name: "MARIA EDUARDA SANTOS", grades: [null, null, null, { sae: 3.5, prova: 7.75 }, null, null]},
                     { id: 223, name: "MICAELLY VITÓRIA SANTOS DO AMOR DIVINO", grades: [null, null, null, { sae: 1.0, prova: 6.75 }, null, null]},
                     { id: 224, name: "SOPHIA SANTOS FRANÇA DE OLIVEIRA", grades: [null, null, null, { sae: 1.0, prova: 10.0 }, null, null]},
                     { id: 225, name: "WELLINGTON SILVA DOS SANTOS", grades: [null, null, null, { sae: 1.0, prova: 5.75 }, null, null]},
                     { id: 226, name: "WENDELL MENEZES SANTOS GOIS", grades: [null, null, null, { sae: 2.5, prova: 4.0 }, null, null]}
                ],
                 "8A": [
                    { id: 301, name: "ALICIA BARBOSA FONTES", grades: [{ final: 10 }, { final: 10 }, { final: 10 }, { sae: 4.5, prova: 8.5 }, null, null]},
                    { id: 302, name: "ALICY DOS SANTOS MONTEIRO", grades: [null, null, null, { sae: 3.5, prova: 3.0 }, null, null]},
                    { id: 303, name: "ANTÔNIO CÉSAR FONTES DE JESUS", grades: [null, null, null, { sae: 2.0, prova: null }, null, null]},
                    { id: 304, name: "ARTHUR GABRIEL CORREIA PASSOS", grades: [null, null, null, { sae: 1.0, prova: 2.0 }, null, null]},
                    { id: 305, name: "CLAUDIO VINICIUS SILVA BISPO", grades: [null, null, null, { sae: 1.0, prova: 2.0 }, null, null]},
                    { id: 306, name: "GABRIEL DA SILVA SANTOS GUIMARÃES", grades: [null, null, null, { sae: 2.5, prova: 4.0 }, null, null]},
                    { id: 307, name: "GUSTAVO CAUÊ ANDRADE DE SÁ", grades: [null, null, null, { sae: 3.4, prova: 3.0 }, null, null]},
                    { id: 308, name: "HELENA VICTÓRIA MATTOS DA SILVA", grades: [null, null, null, { sae: 3.5, prova: 3.5 }, null, null]},
                    { id: 309, name: "HELENA SANTOS RODRIGUES", grades: [null, null, null, { sae: 3.5, prova: 2.0 }, null, null]},
                    { id: 311, name: "JOÃO CARLOS DE SANTANA GONÇALVES", grades: [null, null, null, { sae: 2.0, prova: 3.5 }, null, null]},
                    { id: 312, name: "JOÃO GUILHERME SOUZA DA SILVA", grades: [null, null, null, { sae: 2.0, prova: 2.0 }, null, null]},
                    { id: 313, name: "JULIA GABRIELLY DE FARIA ALVES", grades: [null, null, null, { sae: 2.0, prova: 2.0 }, null, null]},
                    { id: 314, name: "JÚLIA VITÓRIA PEREIRA DOS SANTOS", grades: [null, null, null, { sae: 3.5, prova: 6.0 }, null, null]},
                    { id: 315, name: "KAIO DA SILVA ANUNCIAÇÃO", grades: [null, null, null, { sae: 3.5, prova: 3.0 }, null, null]},
                    { id: 316, name: "KAUÃ FELIPE DE OLIVEIRA ESTEVAM", grades: [null, null, null, { sae: 1.0, prova: null }, null, null]},
                    { id: 317, name: "KAUANNY RODRIGUES SANTOS", grades: [null, null, null, { sae: 3.5, prova: 4.0 }, null, null]},
                    { id: 318, name: "LAVÍNIA LAURENTINO CARDOSO", grades: [null, null, null, { sae: 2.0, prova: 4.0 }, null, null]},
                    { id: 319, name: "LUAN MICKAEL SANTOS CHAGAS", grades: [null, null, null, { sae: 4.5, prova: 3.0 }, null, null]},
                    { id: 320, name: "LUIS MIGUEL SANTANA DE OLIVEIRA", grades: [null, null, null, { sae: 4.5, prova: 3.0 }, null, null]},
                    { id: 321, name: "LUISA GRAZIELLA NUNES DOS SANTOS", grades: [null, null, null, { sae: 2.0, prova: 2.0 }, null, null]},
                    { id: 322, name: "LUIZ FELIPE GOMES DO NASCIMENTO", grades: [null, null, null, { sae: 3.0, prova: 4.0 }, null, null]},
                    { id: 323, name: "MARIA EDUARDA LIMA SILVA PINTO", grades: [null, null, null, { sae: 3.5, prova: 4.0 }, null, null]},
                    { id: 324, name: "MARIA HELENA MATTOS DA SILVA", grades: [null, null, null, { sae: 3.5, prova: 2.5 }, null, null]},
                    { id: 325, name: "MARINA NEVES MELO", grades: [null, null, null, { sae: 2.5, prova: 3.0 }, null, null]},
                    { id: 326, name: "MAYARA VICTORIA SILVA DE ANDRADE", grades: [null, null, null, { sae: 1.0, prova: 1.0 }, null, null]},
                    { id: 327, name: "PEDRO GABRIEL CORREIA RAMOS SANTOS", grades: [null, null, null, { sae: 1.0, prova: null }, null, null]},
                    { id: 328, name: "PEDRO GUILHERME SANTOS SILVA", grades: [null, null, null, { sae: 1.0, prova: 2.0 }, null, null]},
                    { id: 329, name: "PEDRO HENRIQUE SANTOS MESSIAS", grades: [null, null, null, { sae: 1.5, prova: 0.0 }, null, null]},
                    { id: 330, name: "PEDRO HENRIQUE TELES RODRIGUES", grades: [null, null, null, { sae: 1.0, prova: 0.0 }, null, null]},
                    { id: 331, name: "PEDRO VINÍCIUS RODRIGUES CORTES", grades: [null, null, null, { sae: 3.5, prova: 3.0 }, null, null]},
                    { id: 332, name: "VITÓRIA REGINA SANTOS DÓRIA", grades: [null, null, null, { sae: 3.5, prova: 4.0 }, null, null]},
                    { id: 333, name: "WILLIAN EMMANUEL VIEIRA CALIXTO", grades: [null, null, null, { sae: 2.5, prova: 2.0 }, null, null]}
                ], 
                "9A": [
                    { id: 401, name: "ADAILTON SANTOS CAVALCANTE FILHO", grades: [null, null, null, { sae: 1.5, prova: 4.0 }, null, null]},
                    { id: 402, name: "ALEXANDRE DE OLIVEIRA SANTOS", grades: [null, null, null, { sae: 0.0, prova: 2.8 }, null, null]},
                    { id: 403, name: "ANTONY PIETRO PEREIRA DA SILVA", grades: [null, null, null, { sae: 1.0, prova: 2.0 }, null, null]},
                    { id: 404, name: "ARTHUR FEITOSA DE SOUZA", grades: [null, null, null, { sae: 0.0, prova: 3.2 }, null, null]},
                    { id: 405, name: "ARTHUR GOMES E SILVA", grades: [null, null, null, { sae: 3.5, prova: 5.0 }, null, null]},
                    { id: 406, name: "ARTHUR SAMUEL DA SILVA OLIVEIRA COSTA", grades: [null, null, null, { sae: 1.5, prova: 3.5 }, null, null]},
                    { id: 407, name: "CARLOS EDUARDO MILTON SANTOS", grades: [null, null, null, { sae: 1.0, prova: 3.2 }, null, null]},
                    { id: 408, name: "GABRIELY VIEIRA DOS SANTOS", grades: [null, null, null, { sae: 2.5, prova: 5.0, atividade: 1.0 }, null, null]},
                    { id: 409, name: "ÍCARO GUILHERME OLIVEIRA SANTANA", grades: [null, null, null, null, null, null]},
                    { id: 410, name: "ÍCARO SAMUEL DAS DORES SANTOS", grades: [null, null, null, { sae: 0.0, prova: 4.5 }, null, null]},
                    { id: 411, name: "JOÃO GABRIEL MONTEIRO DA CONCEIÇÃO", grades: [null, null, null, { sae: 1.5, prova: 5.5 }, null, null]},
                    { id: 412, name: "JOÃO GUILHERME DOS SANTOS", grades: [null, null, null, { sae: 3.5, prova: 6.5 }, null, null]},
                    { id: 413, name: "JOÃO VICTOR SILVA BISPO", grades: [null, null, null, { sae: 3.5, prova: 5.0 }, null, null]},
                    { id: 414, name: "LAILA SOPHIA NUNES DE JESUS", grades: [null, null, null, { sae: 1.5, prova: 1.7, atividade: 1.0 }, null, null]},
                    { id: 415, name: "LETÍCIA SANTOS DE OLIVEIRA", grades: [null, null, null, { sae: 0.0, prova: 4.5, atividade: 1.0 }, null, null]},
                    { id: 416, name: "LUIZ PAULO BASTOS ZABINE", grades: [null, null, null, { sae: 1.5, prova: 4.5 }, null, null]},
                    { id: 417, name: "MANOEL MESSIAS DOS SANTOS BRANDÃO NETO", grades: [null, null, null, { sae: 1.0, prova: 5.7 }, null, null]},
                    { id: 418, name: "MARIA FERNANDA SANTANA HORA", grades: [null, null, null, { sae: 2.5, prova: 3.0, atividade: 1.0 }, null, null]},
                    { id: 419, name: "MATEUS SOUZA SANTOS", grades: [null, null, null, { sae: 1.5, prova: 4.5 }, null, null]},
                    { id: 420, name: "RAISSA DE MENEZES NASCIMENTO", grades: [null, null, null, { sae: 5.0, prova: 7.0 }, null, null]},
                    { id: 421, name: "REBECA VIEIRA SANTOS", grades: [null, null, null, { sae: 3.5, prova: 4.5, atividade: 1.0 }, null, null]},
                    { id: 422, name: "RICARDO SANTANA SILVA", grades: [null, null, null, { sae: 1.0, prova: 5.5 }, null, null]},
                    { id: 423, name: "SYLVIA VITÓRIA OLIVEIRA SANTOS", grades: [null, null, null, { sae: 1.0, prova: 4.0 }, null, null]},
                    { id: 424, name: "VITORIA CAMILLY DOS SANTOS", grades: [null, null, null, { sae: 1.5, prova: 5.8 }, null, null]},
                    { id: 425, name: "WANDERSON SANTOS VITORINO", grades: [null, null, null, { sae: 2.5, prova: 5.0 }, null, null]}
                ], 
                "9B": [
                    { id: 501, name: "ADERLAN MENEZES RIBEIRO FILHO", grades: [null, null, null, { sae: 1.0, prova: 1.0 }, null, null]},
                    { id: 502, name: "AMANDA SOPHIA SANTOS DA PAZ", grades: [null, null, null, { sae: 1.5, prova: 7.5 }, null, null]},
                    { id: 503, name: "ANANDA DEOCLECIANO SOUZA", grades: [null, null, null, { sae: 3.5, prova: 2.5 }, null, null]},
                    { id: 504, name: "ANTONIO RAFAEL REGO DE BARROS", grades: [null, null, null, { sae: 2.5, prova: 4.0 }, null, null]},
                    { id: 505, name: "ARTUR SANTOS DE JESUS", grades: [null, null, null, { sae: 3.5, prova: 5.0 }, null, null]},
                    { id: 506, name: "CARLA VALENTINA MARTINEZ DA ROCHA", grades: [null, null, null, { sae: 1.5, prova: null }, null, null]},
                    { id: 507, name: "ENZO GABRIEL FRANÇA SANTOS", grades: [null, null, null, { sae: 1.0, prova: 6.5 }, null, null]},
                    { id: 508, name: "GUSTAVO HENRIQUE SANTOS CRUZ", grades: [null, null, null, { sae: 3.5, prova: 4.0 }, null, null]},
                    { id: 509, name: "HELLEN MARIA ALVES FERREIRA DA SILVA", grades: [null, null, null, { sae: 2.5, prova: null }, null, null]},
                    { id: 510, name: "KLEBER JOSÉ CORDEIRO JUNIOR", grades: [null, null, null, { sae: 3.5, prova: 2.3 }, null, null]},
                    { id: 511, name: "LETÍCIA LUIZA SANTOS DE JESUS", grades: [null, null, null, { sae: 1.0, prova: null }, null, null]},
                    { id: 512, name: "LUCAS GABRIEL SANTOS DA SILVA ALMEIDA", grades: [null, null, null, { sae: 2.5, prova: 8.0 }, null, null]},
                    { id: 513, name: "MARIA CLARA SANTOS SILVA", grades: [null, null, null, { sae: 1.5, prova: 3.0 }, null, null]},
                    { id: 514, name: "PEDRO GABRIEL DE OLIVEIRA GOIS", grades: [null, null, null, { sae: 1.0, prova: 4.5 }, null, null]},
                    { id: 515, name: "RUAN NOGUEIRA NASCIMENTO", grades: [null, null, null, { sae: 2.5, prova: 5.0 }, null, null]},
                    { id: 516, name: "THAYS SOPHIA SIDRONIO SILVA DOS SANTOS", grades: [null, null, null, { sae: 1.5, prova: 1.0 }, null, null]},
                    { id: 517, name: "YAWAN DOS SANTOS SILVA", grades: [null, null, null, { sae: 3.5, prova: 3.5 }, null, null]},
                    { id: 519, name: "YANNE BEATRIZ MEDEIROS NICOLAU DOS SANTOS", grades: [null, null, null, { sae: 2.5, prova: 4.0 }, null, null]}
                ]
            };

            const studentData = JSON.parse(JSON.stringify(initialStudentData));
            
            let currentClass = null;
            let currentSearchTerm = '';
            let currentStudentForModal = null;

            const studentListEl = document.getElementById('student-list');
            const searchInputEl = document.getElementById('search-input');
            const classTabsEl = document.getElementById('class-tabs');
            const classTitleEl = document.getElementById('class-title');
            const editModalEl = document.getElementById('edit-modal');
            const editStudentNameEl = document.getElementById('edit-student-name');
            const editFormContentEl = document.getElementById('edit-form-content');
            const closeEditModalBtn = document.getElementById('close-edit-modal-btn');
            const saveGradesBtn = document.getElementById('save-grades-btn');
            const reportModalEl = document.getElementById('report-modal');
            const reportContentEl = document.getElementById('report-content');
            const closeReportModalBtn = document.getElementById('close-report-modal-btn');
            const printReportBtn = document.getElementById('print-report-btn');
            const aiAnalysisBtn = document.getElementById('ai-analysis-btn');
            const aiAnalysisContainer = document.getElementById('ai-analysis-container');

            const apiKey = "AIzaSyDxcxVmGPBbg7mJ6_cmMDkHrDpbx3Lspik"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const calculateUnitFinal = (sae, prova, atividade) => {
                const saeNum = parseFloat(sae) || 0;
                const provaNum = parseFloat(prova) || 0;
                const atividadeNum = parseFloat(atividade) || 0;
                if ([sae, prova, atividade].every(v => v === null || isNaN(v))) return null;
                const final = saeNum + provaNum + atividadeNum;
                return Math.min(final, 10);
            };

            const calculateOverallAverage = (grades) => {
                const validUnits = grades.filter(g => g && g.final !== null && typeof g.final !== 'undefined');
                if (validUnits.length === 0) return null;
                const total = validUnits.reduce((sum, g) => sum + g.final, 0);
                return total / validUnits.length;
            };
            
            Object.values(studentData).flat().forEach(student => {
                student.grades.forEach((grade, index) => {
                    if (grade) {
                        if(index >= 3){ // Unidades 4, 5, 6
                             grade.final = calculateUnitFinal(grade.sae, grade.prova, grade.atividade);
                        }
                    }
                });
                student.overallAverage = calculateOverallAverage(student.grades);
            });

            const getFinalGradeColor = (grade) => {
                if (grade === null || typeof grade === 'undefined') return 'text-gray-400';
                if (grade >= 6) return 'text-green-600';
                if (grade >= 4) return 'text-yellow-600';
                return 'text-red-600';
            };

            const renderStudents = () => {
                if (!currentClass) {
                    studentListEl.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-gray-500">Nenhuma turma selecionada.</td></tr>`;
                    classTitleEl.textContent = 'Selecione uma turma para começar';
                    return;
                }
                const students = studentData[currentClass]
                    .filter(student => student.name.toLowerCase().includes(currentSearchTerm.toLowerCase()))
                    .sort((a, b) => a.name.localeCompare(b.name));
                classTitleEl.textContent = `Turma ${currentClass.replace('A', 'º Ano "A"').replace('B', 'º Ano "B"')}`;
                if (students.length === 0) {
                    studentListEl.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-gray-500">Nenhum aluno encontrado.</td></tr>`;
                    return;
                }
                studentListEl.innerHTML = students.map(student => `
                    <tr class="border-b border-gray-100 hover:bg-gray-50 transition-colors">
                        <td class="p-4 font-medium text-gray-800">${student.name}</td>
                        <td class="p-4 text-center">
                            <span class="font-semibold text-lg ${getFinalGradeColor(student.overallAverage)}">
                                ${student.overallAverage !== null ? student.overallAverage.toFixed(1) : 'N/D'}
                            </span>
                        </td>
                        <td class="p-4 text-center space-x-2">
                            <button data-student-id="${student.id}" class="edit-btn bg-gray-200 text-gray-800 font-semibold px-4 py-2 rounded-lg hover:bg-gray-300 transition text-sm">Editar</button>
                            <button data-student-id="${student.id}" class="report-btn bg-green-100 text-green-800 font-semibold px-4 py-2 rounded-lg hover:bg-green-200 transition text-sm">Relatório</button>
                        </td>
                    </tr>`).join('');
            };

            const openEditModal = (student) => {
                currentStudentForModal = student;
                editStudentNameEl.textContent = student.name;
                editFormContentEl.innerHTML = [1, 2, 3, 4, 5, 6].map(unitNum => {
                    const grade = student.grades[unitNum - 1] || {};
                    if (unitNum <= 3) {
                        return `<div class="p-4 border rounded-lg">
                                <h4 class="font-semibold text-md text-gray-700 mb-2">${unitNum}ª Unidade</h4>
                                <div>
                                    <label for="final-u${unitNum}" class="text-sm font-medium text-gray-600">Nota Final</label>
                                    <input type="number" id="final-u${unitNum}" step="0.1" min="0" max="10" value="${grade.final ?? ''}" class="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none">
                                </div>
                            </div>`;
                    } else {
                        return `<div class="p-4 border rounded-lg">
                            <h4 class="font-semibold text-md text-gray-700 mb-2">${unitNum}ª Unidade</h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="sae-u${unitNum}" class="text-sm font-medium text-gray-600">SAE</label>
                                    <input type="number" id="sae-u${unitNum}" step="0.1" min="0" max="10" value="${grade.sae ?? ''}" class="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none">
                                </div>
                                <div>
                                    <label for="prova-u${unitNum}" class="text-sm font-medium text-gray-600">Prova</label>
                                    <input type="number" id="prova-u${unitNum}" step="0.01" min="0" max="10" value="${grade.prova ?? ''}" class="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none">
                                </div>
                                <div>
                                    <label for="atividade-u${unitNum}" class="text-sm font-medium text-gray-600">Atividades</label>
                                    <input type="number" id="atividade-u${unitNum}" step="0.1" min="0" max="10" value="${grade.atividade ?? ''}" class="w-full mt-1 p-2 border rounded-md focus:ring-2 focus:ring-green-500 focus:outline-none">
                                </div>
                            </div>
                        </div>`;
                    }
                }).join('');
                editModalEl.classList.remove('hidden');
                setTimeout(() => {
                    editModalEl.classList.remove('opacity-0');
                    editModalEl.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };

            const closeEditModal = () => {
                editModalEl.classList.add('opacity-0');
                editModalEl.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => { editModalEl.classList.add('hidden'); currentStudentForModal = null; }, 300);
            };

            const saveGrades = () => {
                for (let i = 1; i <= 6; i++) {
                    if (i <= 3) {
                        const finalInput = document.getElementById(`final-u${i}`);
                        const final = finalInput.value !== '' ? parseFloat(finalInput.value) : null;
                        currentStudentForModal.grades[i-1] = final !== null ? { final } : null;
                    } else {
                        const sae = document.getElementById(`sae-u${i}`).value !== '' ? parseFloat(document.getElementById(`sae-u${i}`).value) : null;
                        const prova = document.getElementById(`prova-u${i}`).value !== '' ? parseFloat(document.getElementById(`prova-u${i}`).value) : null;
                        const atividade = document.getElementById(`atividade-u${i}`).value !== '' ? parseFloat(document.getElementById(`atividade-u${i}`).value) : null;
                        
                        if (sae !== null || prova !== null || atividade !== null) {
                             currentStudentForModal.grades[i-1] = {
                                sae, prova, atividade,
                                final: calculateUnitFinal(sae, prova, atividade)
                            };
                        } else {
                            currentStudentForModal.grades[i-1] = null;
                        }
                    }
                }
                currentStudentForModal.overallAverage = calculateOverallAverage(currentStudentForModal.grades);
                renderStudents();
                closeEditModal();
            };

            const openReportModal = (student) => {
                currentStudentForModal = student;
                let reportHTML = `<p class="mb-4"><strong>Aluno(a):</strong> ${student.name}</p>`;
                reportHTML += `<p class="mb-2"><strong>Turma:</strong> ${currentClass.replace('A', 'º Ano "A"').replace('B', 'º Ano "B"')}</p><hr class="my-4">`;
                reportHTML += `<h3 class="font-semibold text-lg text-gray-800 mb-2">Resumo das Notas</h3>`;
                const gradesHTML = student.grades.map((g, i) => g && g.final !== null && typeof g.final !== 'undefined' ? `<li><strong>${i+1}ª Unidade:</strong> Nota ${g.final.toFixed(1)}</li>` : `<li><strong>${i+1}ª Unidade:</strong> N/D</li>`).join('');
                reportHTML += `<ul class="list-disc list-inside mb-4">${gradesHTML}</ul>`;
                reportHTML += `<p class="text-center font-bold text-lg ${getFinalGradeColor(student.overallAverage)}">Média Final: ${student.overallAverage !== null ? student.overallAverage.toFixed(1) : 'N/D'}</p>`;
                reportContentEl.innerHTML = reportHTML;
                
                aiAnalysisContainer.style.display = 'none';
                aiAnalysisContainer.innerHTML = '';
                document.querySelectorAll('#qualitative-assessment input[type="radio"]').forEach(r => r.checked = false);
                document.getElementById('observations').value = '';
                printReportBtn.disabled = true;

                reportModalEl.classList.remove('hidden');
                setTimeout(() => {
                    reportModalEl.classList.remove('opacity-0');
                    reportModalEl.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            };
            
            const closeReportModal = () => {
                reportModalEl.classList.add('opacity-0');
                reportModalEl.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => { reportModalEl.classList.add('hidden'); currentStudentForModal = null; }, 300);
            };

            const generateAIAnalysis = async () => {
                if (!currentStudentForModal) return;

                aiAnalysisContainer.style.display = 'block';
                aiAnalysisContainer.innerHTML = '<div class="loader"></div>';
                aiAnalysisBtn.disabled = true;

                const student = currentStudentForModal;
                const qualitativeData = {
                    participation: document.querySelector('input[name="participation"]:checked')?.value || 'Não informado',
                    homework: document.querySelector('input[name="homework"]:checked')?.value || 'Não informado',
                    behavior: document.querySelector('input[name="behavior"]:checked')?.value || 'Não informado',
                    interest: document.querySelector('input[name="interest"]:checked')?.value || 'Não informado',
                    observations: document.getElementById('observations').value || 'Nenhuma.',
                };
                
                const prompt = `
                    Você é um especialista em psicopedagogia e sua tarefa é criar uma análise técnica e objetiva sobre o perfil de aprendizagem do(a) aluno(a) ${student.name}, para uso interno do professor e da coordenação pedagógica. Não se dirija ao aluno ou aos pais. A análise deve ser estruturada e organizada.

                    Dados Quantitativos:
                    - ${student.grades.map((g, i) => g && g.final !== null ? `Nota da ${i+1}ª unidade: ${g.final.toFixed(1)}` : `Nota da ${i+1}ª unidade: Não lançada`).join('\n- ')}
                    - Média Final: ${student.overallAverage !== null ? student.overallAverage.toFixed(1) : 'N/A'}
                    - A média para aprovação é 6.0.

                    Avaliação Qualitativa do Professor:
                    - Participação em aula: ${qualitativeData.participation}
                    - Entrega de tarefas: ${qualitativeData.homework}
                    - Comportamento em sala: ${qualitativeData.behavior}
                    - Interesse pela matéria: ${qualitativeData.interest}
                    - Observações adicionais: ${qualitativeData.observations}

                    Com base nesses dados, gere um relatório estruturado nos seguintes tópicos:

                    Análise Pedagógica

                    Pontos Fortes:
                    (Descreva aqui as qualidades observadas, como consistência nas notas, bom comportamento, participação, etc.)

                    Pontos de Atenção:
                    (Descreva aqui as áreas que necessitam de desenvolvimento, como oscilação de notas, dificuldades em tarefas, comportamento, etc.)

                    Sugestões Pedagógicas:
                    (Apresente aqui estratégias e intervenções que o professor pode aplicar para auxiliar o aluno a melhorar nos pontos de atenção.)
                `;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(text){
                         // Remove potential markdown and ensure structure
                        let cleanedText = text.replace(/Pontos Fortes:|Pontos de Atenção:|Sugestões Pedagógicas:|Análise Pedagógica/gi, '').trim();
                        let sections = cleanedText.split(/\n\s*\n/);
                        let html = '<strong>Análise Pedagógica</strong>';
                        if (sections.length >= 3) {
                             html += `<br><br><strong>Pontos Fortes:</strong><br>${sections[0].trim()}`;
                             html += `<br><br><strong>Pontos de Atenção:</strong><br>${sections[1].trim()}`;
                             html += `<br><br><strong>Sugestões Pedagógicas:</strong><br>${sections[2].trim()}`;
                        } else {
                            html = text.replace(/\n/g, '<br>'); // Fallback
                        }
                        aiAnalysisContainer.innerHTML = html;
                        printReportBtn.disabled = false;
                    } else {
                        aiAnalysisContainer.innerHTML = '<p class="text-red-500">Não foi possível gerar a análise.</p>';
                    }
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    aiAnalysisContainer.innerHTML = '<p class="text-red-500">Erro ao gerar a análise. Tente novamente.</p>';
                } finally {
                    aiAnalysisBtn.disabled = false;
                }
            };
            
            const classColors = {
                "6A": "bg-blue-500 hover:bg-blue-600",
                "7A": "bg-teal-500 hover:bg-teal-600",
                "8A": "bg-purple-500 hover:bg-purple-600",
                "9A": "bg-pink-500 hover:bg-pink-600",
                "9B": "bg-indigo-500 hover:bg-indigo-600"
            };

            const classNames = Object.keys(studentData);
            classTabsEl.innerHTML = classNames.map(name => `
                <button data-class="${name}" class="class-tab px-4 py-2 rounded-lg text-white font-semibold transition shadow-md ${classColors[name]}">
                    ${name.replace('A', 'º Ano "A"').replace('B', 'º Ano "B"')}
                </button>
            `).join('');
            
            classTabsEl.addEventListener('click', (e) => {
                if(e.target.matches('.class-tab')) {
                    currentClass = e.target.dataset.class;
                    document.querySelectorAll('.class-tab').forEach(t => t.classList.remove('active-tab'));
                    e.target.classList.add('active-tab');
                    renderStudents();
                }
            });

            searchInputEl.addEventListener('keyup', (e) => { currentSearchTerm = e.target.value; renderStudents(); });
            
            studentListEl.addEventListener('click', (e) => {
                const button = e.target.closest('button');
                if (!button) return;
                const studentId = button.dataset.studentId;
                const student = studentData[currentClass].find(s => s.id == studentId);
                if (button.matches('.edit-btn')) openEditModal(student);
                if (button.matches('.report-btn')) openReportModal(student);
            });

            saveGradesBtn.addEventListener('click', saveGrades);
            closeEditModalBtn.addEventListener('click', closeEditModal);
            closeReportModalBtn.addEventListener('click', closeReportModal);
            aiAnalysisBtn.addEventListener('click', generateAIAnalysis);

            printReportBtn.addEventListener('click', () => {
                const title = "Relatório Pedagógico do Aluno"
                const printContent = document.getElementById('report-content').innerHTML + document.getElementById('ai-analysis-container').innerHTML;
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`<html><head><title>${title}</title><script src="https://cdn.tailwindcss.com"><\/script><style>body { font-family: 'Inter', sans-serif; padding: 2rem; } #ai-analysis-container { margin-top: 1.5rem; padding: 1rem; border-radius: 0.5rem; } .loader { display: none; }</style></head><body><h1 class="text-2xl font-bold mb-4">${title}</h1>${printContent}</body></html>`);
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => { printWindow.print(); printWindow.close(); }, 250);
            });
        });
    </script>
</body>
</html>
