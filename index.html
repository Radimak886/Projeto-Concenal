<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>INFINITY MIND's 2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/12.4.2/math.min.js"></script>
    
    <!-- Configura√ß√£o do MathJax -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']], 
                displayMath: [['$$', '$$'], ['\\[', '\\]']] 
            },
            svg: { fontCache: 'global' }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
    </script>
    <!-- PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #E5E7EB; 
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        /* Scrollbar Personalizada */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* Anima√ß√µes */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { to { transform: rotate(360deg); } }

        .menu-card {
            background-color: #1e293b;
            border-radius: 16px;
            padding: 16px;
            border: 1px solid #334155;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            height: 100%;
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
        }
        .menu-card:active { transform: scale(0.96); background-color: #334155; }
        .menu-card:hover { border-color: #8B5CF6; transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(139, 92, 246, 0.3); }
        .menu-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, #8B5CF6, #EC4899); opacity: 0; transition: opacity 0.2s;
        }
        .menu-card:hover::before { opacity: 1; }
        
        .menu-card-icon { font-size: 2rem; margin-bottom: 0.5rem; }
        .menu-card h3 { font-weight: 600; color: white; margin-bottom: 0.25rem; font-size: 0.95rem; line-height: 1.2; }

        .tool-page { display: none; animation: fadeIn 0.3s ease-out; padding-bottom: 80px; }
        
        .input-field, .textarea-field, .select-field {
            width: 100%; padding: 12px; background-color: #334155;
            border: 1px solid #475569; color: white; border-radius: 10px;
            margin-top: 8px; font-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus, .textarea-field:focus { outline: none; border-color: #8B5CF6; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.2); }
        
        .calc-button {
            width: 100%; padding: 14px; border-radius: 10px; color: white;
            font-weight: 600; border: none; cursor: pointer; margin-top: 16px;
            transition: transform 0.1s, filter 0.2s;
            background-image: linear-gradient(to right, #7C3AED, #DB2777);
            display: flex; justify-content: center; align-items: center; gap: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            min-height: 50px;
        }
        .calc-button:active { transform: scale(0.98); }
        .calc-button:hover { filter: brightness(1.1); }
        .calc-button:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        .gemini-button { background-image: linear-gradient(to right, #059669, #10B981); }

        .result-box {
            margin-top: 20px; padding: 16px;
            background-color: #1e293b; border: 1px solid #334155;
            border-left: 4px solid #8B5CF6;
            border-radius: 8px; color: #E2E8F0; line-height: 1.6;
            min-height: 60px; word-wrap: break-word;
        }
        .result-box h3 { color: #A78BFA; font-weight: bold; margin-bottom: 8px; font-size: 1.1em; }
        .result-box ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; }
        .result-box li { margin-bottom: 4px; }
        .result-box strong { color: #fff; }

        .loader {
            width: 20px; height: 20px; border: 2px solid #FFF;
            border-bottom-color: transparent; border-radius: 50%;
            animation: spin 0.8s linear infinite; display: inline-block;
        }

        .basic-calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .basic-calc-grid button {
            padding: 12px; font-size: 1.25rem; border-radius: 12px;
            background-color: #334155; color: white; border: none;
            box-shadow: 0 2px 0 #1e293b; min-height: 60px;
        }
        .basic-calc-grid button:active { transform: translateY(2px); box-shadow: none; }
        .basic-calc-grid .operator { background-color: #4C1D95; }
        .basic-calc-grid .equal { background-color: #BE185D; grid-column: span 2; }

        .chat-bubble { padding: 10px 14px; border-radius: 12px; max-width: 90%; margin-bottom: 10px; font-size: 0.95rem; line-height: 1.5; animation: fadeIn 0.2s; word-wrap: break-word; }
        .chat-user { background-color: #4C1D95; color: white; align-self: flex-end; margin-left: auto; border-bottom-right-radius: 2px; }
        .chat-ai { background-color: #334155; color: #E2E8F0; align-self: flex-start; margin-right: auto; border-bottom-left-radius: 2px; border: 1px solid #475569; }

        #mindMapContainer { overflow: hidden; height: 350px; background: #1e293b; border-radius: 10px; border: 1px solid #334155; display: flex; align-items: center; justify-content: center;}

        #apiKeyModal { backdrop-filter: blur(8px); background-color: rgba(0, 0, 0, 0.7); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header Fixo -->
    <header class="bg-slate-900 border-b border-slate-700 sticky top-0 z-50 shadow-md">
        <div class="max-w-6xl mx-auto px-4 py-3 flex flex-row justify-between items-center gap-2">
            <div class="flex items-center gap-2 md:gap-3 flex-grow">
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-lg bg-gradient-to-br from-purple-600 to-pink-600 flex items-center justify-center text-white font-bold text-lg md:text-xl flex-shrink-0">‚àû</div>
                <div class="text-left leading-tight">
                    <h1 class="text-lg md:text-2xl font-bold text-white tracking-tight truncate">INFINITY MIND's <span class="hidden md:inline text-xs bg-purple-900 text-purple-200 px-2 py-0.5 rounded ml-1">v2.0</span></h1>
                    <p class="text-[9px] md:text-[10px] text-gray-400 uppercase tracking-widest font-semibold">Prof. Kelvin - Sistema Educacional</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <select id="language-switcher" class="bg-slate-800 border border-slate-600 text-white text-xs md:text-sm rounded-lg p-2 md:p-2 focus:border-purple-500 outline-none max-w-[100px]" onchange="changeLanguage(this.value)">
                    <option value="pt-br">üáßüá∑ PT</option>
                    <option value="en">üá¨üáß EN</option>
                    <option value="es">üá™üá∏ ES</option>
                    <option value="it">üáÆüáπ IT</option>
                    <option value="de">üá©üá™ DE</option>
                </select>
                <button onclick="showApiKeyModal()" class="p-2 rounded-full bg-slate-800 hover:bg-slate-700 border border-slate-600 text-yellow-400 hover:text-yellow-300 transition" title="Configurar API Key">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Modal de API Key -->
    <div id="apiKeyModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 p-6 rounded-2xl border border-purple-500/50 shadow-2xl max-w-md w-full transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-white flex items-center gap-2">üîê Acesso Gemini AI</h3>
                <button onclick="closeApiKeyModal()" class="text-gray-400 hover:text-white text-2xl px-2">&times;</button>
            </div>
            <p class="text-gray-300 text-sm mb-4">Para usar os recursos de IA (Tutor, Solu√ß√µes, Imagens), voc√™ precisa de uma chave gratuita do Google.</p>
            <input type="password" id="modalApiKeyInput" class="input-field mb-4 font-mono text-sm" placeholder="Cole sua API Key aqui (AIza...)">
            <div class="flex justify-end gap-2">
                <button onclick="saveApiKeyFromModal()" class="px-5 py-2.5 rounded-lg bg-purple-600 hover:bg-purple-500 text-white font-bold transition shadow-lg shadow-purple-900/20 w-full sm:w-auto">Salvar & Conectar</button>
            </div>
            <p class="text-xs text-gray-500 mt-4 text-center">N√£o tem uma chave? <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-purple-400 underline hover:text-purple-300">Criar no Google AI Studio</a></p>
        </div>
    </div>

    <div class="container mx-auto p-3 md:p-4 max-w-6xl flex-grow">
        
        <!-- Menu Principal -->
        <main id="home-page" class="py-4 md:py-6">
            <div class="text-center mb-6 md:mb-10">
                <h2 class="text-2xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400 mb-2">Central de Ferramentas</h2>
                <p data-lang-key="welcome_desc" class="text-gray-400 text-sm md:text-base max-w-2xl mx-auto px-4">
                    Potencialize seus estudos e dia a dia com intelig√™ncia artificial e matem√°tica precisa.
                </p>
            </div>

            <div class="space-y-6 md:space-y-10">
                <!-- Se√ß√£o 1: Matem√°tica -->
                <div>
                    <div class="flex items-center gap-3 mb-3 border-b border-slate-700 pb-2">
                        <span class="text-xl md:text-2xl">üìê</span>
                        <h2 class="text-purple-400 font-bold text-lg md:text-xl">Matem√°tica & C√°lculos</h2>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4">
                        <div class="menu-card" onclick="showTool('tool-basic-calc')"><div class="menu-card-icon">üßÆ</div><h3 data-lang-key="tool_basic_calc_title">Calculadora</h3></div>
                        <div class="menu-card" onclick="showTool('tool-equations')"><div class="menu-card-icon">üî¢</div><h3 data-lang-key="tool_equations_title">Sistemas Lineares</h3></div>
                        <div class="menu-card" onclick="showTool('tool-quadratic')"><div class="menu-card-icon">üìà</div><h3 data-lang-key="tool_quadratic_title">Bhaskara (2¬∫ Grau)</h3></div>
                        <div class="menu-card" onclick="showTool('tool-percentage')"><div class="menu-card-icon">üìä</div><h3 data-lang-key="tool_percentage_title">Porcentagem</h3></div>
                        <div class="menu-card" onclick="showTool('tool-graph-plotter')"><div class="menu-card-icon">üìâ</div><h3 data-lang-key="tool_graph_plotter_title">Gr√°ficos</h3></div>
                        <div class="menu-card" onclick="showTool('tool-measurement')"><div class="menu-card-icon">üìè</div><h3 data-lang-key="tool_measurement_title">Conversor</h3></div>
                    </div>
                </div>

                <!-- Se√ß√£o 2: IA Avan√ßada -->
                <div>
                    <div class="flex items-center gap-3 mb-3 border-b border-slate-700 pb-2">
                        <span class="text-xl md:text-2xl">ü§ñ</span>
                        <h2 class="text-green-400 font-bold text-lg md:text-xl">Intelig√™ncia Artificial</h2>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4">
                         <div class="menu-card border-green-500/30 bg-green-900/10" onclick="showTool('tool-live-chat')"><div class="menu-card-icon">üéì</div><h3 data-lang-key="tool_live_chat_title">Tutor IA (Chat)</h3></div>
                         <div class="menu-card" onclick="showTool('tool-solve-by-photo')"><div class="menu-card-icon">üì∏</div><h3 data-lang-key="tool_solve_by_photo_title">Resolver Foto</h3></div>
                         <div class="menu-card" onclick="showTool('tool-code-explainer')"><div class="menu-card-icon">üíª</div><h3 data-lang-key="tool_code_explainer_title">Tutor de C√≥digo</h3></div>
                         <div class="menu-card" onclick="showTool('tool-word-problem')"><div class="menu-card-icon">üß†</div><h3 data-lang-key="tool_word_problem_title">Problemas L√≥gicos</h3></div>
                         <div class="menu-card" onclick="showTool('tool-mind-map')"><div class="menu-card-icon">üó∫Ô∏è</div><h3 data-lang-key="tool_mind_map_title">Mapa Mental</h3></div>
                         <div class="menu-card" onclick="showTool('tool-summarizer')"><div class="menu-card-icon">üìö</div><h3 data-lang-key="tool_summarizer_title">Resumos</h3></div>
                         <div class="menu-card" onclick="showTool('tool-level-explainer')"><div class="menu-card-icon">üì∂</div><h3 data-lang-key="tool_level_explainer_title">N√≠veis de Explica√ß√£o</h3></div>
                    </div>
                </div>

                <!-- Se√ß√£o 3: Vida & Criatividade -->
                <div>
                    <div class="flex items-center gap-3 mb-3 border-b border-slate-700 pb-2">
                        <span class="text-xl md:text-2xl">üöÄ</span>
                        <h2 class="text-pink-400 font-bold text-lg md:text-xl">Criatividade & Sa√∫de</h2>
                    </div>
                    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 md:gap-4">
                        <div class="menu-card" onclick="showTool('tool-interactive-quiz')"><div class="menu-card-icon">‚ö°</div><h3 data-lang-key="tool_interactive_quiz_title">Quiz Infinito</h3></div>
                        <div class="menu-card" onclick="showTool('tool-math-story')"><div class="menu-card-icon">üìö</div><h3 data-lang-key="tool_math_story_title">Hist√≥rias Matem√°ticas</h3></div>
                        <div class="menu-card" onclick="showTool('tool-image-gen')"><div class="menu-card-icon">üé®</div><h3 data-lang-key="tool_image_gen_title">Criar Imagens</h3></div>
                        <div class="menu-card" onclick="showTool('tool-career')"><div class="menu-card-icon">üß≠</div><h3 data-lang-key="tool_career_title">Carreiras</h3></div>
                        <div class="menu-card" onclick="showTool('tool-exercises')"><div class="menu-card-icon">‚úçÔ∏è</div><h3 data-lang-key="tool_exercises_title">Gerar Exerc√≠cios</h3></div>
                        <div class="menu-card" onclick="showTool('tool-bmi')"><div class="menu-card-icon">üí™</div><h3 data-lang-key="tool_bmi_title">IMC + Dieta IA</h3></div>
                        <div class="menu-card" onclick="showTool('tool-currency')"><div class="menu-card-icon">üí±</div><h3 data-lang-key="tool_currency_title">C√¢mbio</h3></div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Container das Ferramentas -->
        <div id="tools-container" class="hidden">
            <div class="mb-4 md:mb-6 sticky top-[68px] z-40 bg-slate-900/95 backdrop-blur py-3 border-b border-slate-800 flex justify-between items-center">
                <button onclick="showHome()" class="text-gray-300 hover:text-white flex items-center gap-2 px-3 py-2 rounded-lg border border-slate-700 bg-slate-800 hover:bg-slate-700 transition">
                    <span class="font-bold">‚Üê</span> <span data-lang-key="back_to_menu" class="hidden sm:inline">Menu</span>
                </button>
                <div id="current-tool-title" class="font-bold text-purple-400 text-base md:text-lg truncate max-w-[200px] text-right"></div>
            </div>

            <div class="max-w-3xl mx-auto">
                
                <!-- Chat Tutor IA -->
                <div id="tool-live-chat" class="tool-page">
                    <div id="lockout-message" class="text-center p-4 bg-red-900/50 border border-red-500 text-white rounded-lg mb-4 hidden font-bold animate-pulse"></div>
                    
                    <div class="bg-slate-800 border border-slate-700 rounded-xl overflow-hidden shadow-2xl flex flex-col h-[70vh] md:h-[500px]">
                        <div class="bg-slate-900 p-3 border-b border-slate-700 flex justify-between items-center flex-shrink-0">
                            <span class="text-green-400 font-bold flex items-center gap-2 text-sm md:text-base"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Tutor Online</span>
                            <div class="flex gap-2">
                                <button onclick="downloadChatPDF()" class="text-xs text-blue-400 hover:text-white px-2 py-1 bg-slate-800 rounded border border-slate-600">üì• Baixar</button>
                                <button onclick="document.getElementById('chatWindow').innerHTML=''" class="text-xs text-gray-500 hover:text-white px-2 py-1 bg-slate-800 rounded border border-slate-600">Limpar</button>
                            </div>
                        </div>
                        <div id="chatWindow" class="flex-grow overflow-y-auto p-3 md:p-4 flex flex-col gap-3 bg-slate-800/50">
                            <!-- Mensagens aparecer√£o aqui -->
                            <div class="chat-bubble chat-ai">Ol√°! Sou seu professor particular. Posso te ajudar com d√∫vidas de matem√°tica, ci√™ncias ou qualquer outra mat√©ria. O que vamos aprender hoje?</div>
                        </div>
                        <div class="p-3 bg-slate-900 border-t border-slate-700 flex-shrink-0">
                            <div class="flex gap-2">
                                <input type="text" id="chatInput" class="flex-grow bg-slate-800 text-white border border-slate-600 rounded-lg px-3 py-3 focus:outline-none focus:border-purple-500 text-base" placeholder="Digite sua d√∫vida..." onkeypress="if(event.key === 'Enter') sendChatMessage()">
                                <button onclick="sendChatMessage()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 md:px-5 rounded-lg font-bold transition flex items-center justify-center">‚û§</button>
                            </div>
                            <div class="mt-2 flex justify-between items-center px-1">
                                <select id="responseStyle" class="bg-transparent text-xs text-gray-400 border-none outline-none cursor-pointer hover:text-white">
                                    <option value="did√°tico">Modo: Did√°tico</option>
                                    <option value="passo-a-passo">Modo: Passo a Passo</option>
                                    <option value="socr√°tico">Modo: Socr√°tico (Perguntas)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- IMC com IA -->
                <div id="tool-bmi" class="tool-page">
                    <h2 class="text-center text-xl md:text-2xl font-bold mb-6 text-pink-400">Calculadora de IMC + IA Nutri</h2>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-sm text-gray-400">Peso (kg)</label>
                            <input type="number" id="weight" class="input-field mt-1" placeholder="Ex: 70">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Altura (cm)</label>
                            <input type="number" id="height" class="input-field mt-1" placeholder="Ex: 175">
                        </div>
                    </div>
                    <button onclick="calculateBMI()" class="calc-button">Calcular e Analisar</button>
                    
                    <!-- Resultados -->
                    <div id="bmiResult" class="hidden mt-6 animate-[fadeIn_0.5s]">
                        <div class="bg-slate-800 rounded-xl p-6 border border-slate-600 text-center relative overflow-hidden">
                            <div class="text-sm text-gray-400 uppercase tracking-wider mb-1">Seu √çndice</div>
                            <div id="bmiValue" class="text-5xl font-bold text-white mb-2">24.5</div>
                            <div id="bmiCategory" class="text-xl font-medium text-purple-400">Normal</div>
                            
                            <!-- Barra de Progresso Visual -->
                            <div class="w-full bg-gray-700 h-2 rounded-full mt-4 overflow-hidden">
                                <div id="bmiBar" class="h-full bg-gradient-to-r from-green-400 to-red-500 w-0 transition-all duration-1000"></div>
                            </div>
                        </div>

                        <!-- IA Suggestion Box -->
                        <div id="bmiAiAdvice" class="mt-4 bg-slate-800/80 border border-pink-500/30 rounded-xl p-5 shadow-lg">
                            <div class="flex items-center gap-2 mb-3 text-pink-400 border-b border-pink-500/20 pb-2">
                                <span class="animate-pulse">‚ú®</span> <strong>Dicas da IA para voc√™</strong>
                            </div>
                            <div id="bmiAiContent" class="text-sm text-gray-300 leading-relaxed">
                                <div class="flex justify-center py-4"><div class="loader"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calculadora B√°sica -->
                <div id="tool-basic-calc" class="tool-page">
                    <input type="text" id="basicCalcDisplay" class="input-field text-right text-3xl mb-4 font-mono h-20 bg-slate-950 border-slate-700" readonly>
                    <div class="basic-calc-grid">
                        <button onclick="clearDisplay()" class="!bg-red-900/80 hover:!bg-red-800 text-red-100">C</button>
                        <button onclick="appendToDisplay('(')" class="text-gray-300">(</button>
                        <button onclick="appendToDisplay(')')" class="text-gray-300">)</button>
                        <button class="operator" onclick="appendToDisplay('/')">√∑</button>
                        <button onclick="appendToDisplay('7')">7</button>
                        <button onclick="appendToDisplay('8')">8</button>
                        <button onclick="appendToDisplay('9')">9</button>
                        <button class="operator" onclick="appendToDisplay('*')">√ó</button>
                        <button onclick="appendToDisplay('4')">4</button>
                        <button onclick="appendToDisplay('5')">5</button>
                        <button onclick="appendToDisplay('6')">6</button>
                        <button class="operator" onclick="appendToDisplay('-')">-</button>
                        <button onclick="appendToDisplay('1')">1</button>
                        <button onclick="appendToDisplay('2')">2</button>
                        <button onclick="appendToDisplay('3')">3</button>
                        <button class="operator" onclick="appendToDisplay('+')">+</button>
                        <button onclick="appendToDisplay('0')">0</button>
                        <button onclick="appendToDisplay('.')">.</button>
                        <button class="equal" onclick="calculateResult()">=</button>
                    </div>
                </div>

                <!-- Resolver por Foto -->
                <div id="tool-solve-by-photo" class="tool-page">
                    <div class="border-2 border-dashed border-slate-600 rounded-xl p-6 md:p-8 text-center hover:bg-slate-800/50 transition cursor-pointer relative" onclick="document.getElementById('imageUpload').click()">
                        <div class="text-4xl mb-2">üì∏</div>
                        <p class="text-gray-400">Clique para enviar uma foto do problema</p>
                        <input type="file" id="imageUpload" class="hidden" accept="image/*" onchange="previewImage(event)">
                    </div>
                    <img id="image-preview" class="hidden w-full mt-4 rounded-lg border border-slate-600 max-h-64 object-contain bg-black">
                    <button id="solveByPhotoBtn" onclick="solveByPhoto()" class="calc-button gemini-button hidden">üîç Analisar e Resolver</button>
                    <div id="solveByPhotoResult" class="result-box hidden"></div>
                </div>

                <!-- CARREIRA MELHORADA -->
                <div id="tool-career" class="tool-page">
                    <h2 class="text-center text-xl md:text-2xl font-bold mb-4 text-pink-400">Orientador de Carreira</h2>
                    <div class="space-y-4 bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <div>
                            <label class="text-sm text-gray-400">Principal Interesse:</label>
                            <input id="careerInterest" class="input-field mt-1" placeholder="Ex: Tecnologia, Biologia, Artes">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Habilidades que voc√™ tem ou gosta:</label>
                            <input id="careerSkills" class="input-field mt-1" placeholder="Ex: Matem√°tica, Desenho, Falar em p√∫blico">
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">N√≠vel de Escolaridade:</label>
                            <select id="careerLevel" class="select-field mt-1">
                                <option>Ensino Fundamental II (6¬∫ ao 9¬∫ ano)</option>
                                <option>Ensino M√©dio</option>
                                <option>Ensino Superior</option>
                            </select>
                        </div>
                        <button onclick="generateCareerPlan()" class="calc-button gemini-button">Gerar Plano de Carreira</button>
                    </div>
                    <div id="careerResult" class="result-box hidden"></div>
                </div>

                <!-- EXERC√çCIOS MELHORADO -->
                <div id="tool-exercises" class="tool-page">
                    <h2 class="text-center text-xl md:text-2xl font-bold mb-4 text-green-400">Gerador de Exerc√≠cios</h2>
                    <div class="space-y-4 bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <div>
                            <label class="text-sm text-gray-400">Assunto:</label>
                            <input id="exTopic" class="input-field mt-1" placeholder="Ex: Equa√ß√£o do 1¬∫ Grau, Fra√ß√µes...">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm text-gray-400">Ano:</label>
                                <select id="exGrade" class="select-field mt-1">
                                    <option>6¬∫ Ano</option>
                                    <option>7¬∫ Ano</option>
                                    <option>8¬∫ Ano</option>
                                    <option>9¬∫ Ano</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-sm text-gray-400">Dificuldade:</label>
                                <select id="exDiff" class="select-field mt-1">
                                    <option>F√°cil (Conceitual)</option>
                                    <option>M√©dio (Pr√°tico)</option>
                                    <option>Dif√≠cil (Desafio)</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-sm text-gray-400">Tipo de Quest√£o:</label>
                            <select id="exType" class="select-field mt-1">
                                <option>M√∫ltipla Escolha</option>
                                <option>Dissertativa (Aberta)</option>
                            </select>
                        </div>
                        <button onclick="generateExercises()" class="calc-button gemini-button">Gerar Lista de Exerc√≠cios</button>
                    </div>
                    <div id="exResult" class="result-box hidden"></div>
                </div>

                <!-- Ferramentas Gen√©ricas de Texto -->
                <div id="tool-word-problem" class="tool-page ai-text-tool" data-prompt="Resolva este problema passo a passo, como um professor paciente:"></div>
                <div id="tool-summarizer" class="tool-page ai-text-tool" data-prompt="Fa√ßa um resumo claro e estruturado em t√≥picos sobre:"></div>
                <div id="tool-level-explainer" class="tool-page ai-text-tool" data-prompt="Explique este conceito em 3 n√≠veis (Crian√ßa, Estudante, Especialista):"></div>
                <div id="tool-math-story" class="tool-page ai-text-tool" data-prompt="Crie uma hist√≥ria curta, criativa e did√°tica que ajude a entender o conceito matem√°tico de: "></div>
                <div id="tool-code-explainer" class="tool-page ai-text-tool" data-prompt="Atue como um programador s√™nior e explique o seguinte c√≥digo de forma did√°tica para um estudante: "></div>
                
                <!-- Bhaskara -->
                <div id="tool-quadratic" class="tool-page">
                    <div class="flex flex-wrap gap-2 items-center justify-center text-lg md:text-xl font-mono mb-6 bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <input type="number" id="coeffA" class="input-field !w-14 md:!w-16 !mt-0 text-center" placeholder="a">
                        <span>x¬≤ +</span>
                        <input type="number" id="coeffB" class="input-field !w-14 md:!w-16 !mt-0 text-center" placeholder="b">
                        <span>x +</span>
                        <input type="number" id="coeffC" class="input-field !w-14 md:!w-16 !mt-0 text-center" placeholder="c">
                        <span>= 0</span>
                    </div>
                    <button onclick="solveQuadratic()" class="calc-button">Calcular Ra√≠zes</button>
                    <div id="quadraticResult" class="result-box text-center hidden"></div>
                    <button id="quadraticExplainBtn" onclick="explainQuadraticSteps()" class="calc-button gemini-button hidden text-sm py-2">üí° Pedir explica√ß√£o para a IA</button>
                    <div id="quadraticExplainResult" class="result-box hidden"></div>
                </div>

                <!-- Quiz -->
                <div id="tool-interactive-quiz" class="tool-page">
                    <div id="quiz-setup">
                        <label class="text-gray-400 block mb-2">Tema do Quiz:</label>
                        <input type="text" id="quizTopic" class="input-field mb-4" placeholder="Ex: Tabela Peri√≥dica, Segunda Guerra...">
                        <button onclick="startQuiz()" class="calc-button gemini-button">Iniciar Desafio</button>
                    </div>
                    <div id="quiz-game" class="hidden">
                        <div id="quiz-question-container" class="bg-slate-800 p-4 md:p-6 rounded-xl border border-slate-700">
                            <div id="quiz-loader" class="text-center py-8">
                                <div class="loader text-purple-500"></div>
                                <p class="mt-4 text-sm text-gray-400 animate-pulse">Gerando desafio...</p>
                            </div>
                            <div id="quiz-content" class="hidden">
                                <div class="flex justify-between items-center mb-4">
                                    <span class="text-xs font-bold text-purple-400 uppercase">Pergunta</span>
                                    <span id="quiz-score" class="text-xs bg-slate-700 px-2 py-1 rounded">Pontos: 0</span>
                                </div>
                                <p id="quiz-question-text" class="text-base md:text-lg font-bold text-white mb-6 leading-relaxed"></p>
                                <div id="quiz-options" class="grid gap-3"></div>
                                <div id="quiz-feedback" class="mt-4 hidden p-4 rounded-lg text-sm border"></div>
                                <button onclick="nextQuizQuestion()" id="quiz-next-btn" class="calc-button mt-4 hidden">Pr√≥xima Pergunta ‚Üí</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mapa Mental -->
                <div id="tool-mind-map" class="tool-page">
                    <input type="text" id="mindMapSubject" class="input-field" placeholder="Digite um tema central (Ex: Sistema Solar)">
                    <button id="generateMindMapBtn" onclick="generateMindMap()" class="calc-button gemini-button">Gerar Mapa Mental</button>
                    <div id="mindMapContainer" class="mt-6 relative">
                        <p class="text-gray-500 text-sm absolute">O mapa aparecer√° aqui</p>
                    </div>
                </div>

                <!-- Gerador de Imagens -->
                <div id="tool-image-gen" class="tool-page">
                    <textarea id="imagePrompt" class="textarea-field h-32" placeholder="Descreva a imagem que voc√™ quer criar..."></textarea>
                    <button id="generateImageBtn" onclick="generateImage()" class="calc-button gemini-button">Gerar Imagem (IA)</button>
                    <div id="imageResult" class="result-box mt-4 flex justify-center items-center min-h-[200px]"></div>
                </div>

                <!-- Outros tools -->
                <div id="tool-equations" class="tool-page">
                    <div class="space-y-3">
                        <div class="flex gap-2 items-center"><input id="eq_a1" type="number" class="input-field" placeholder="a1">x + <input id="eq_b1" type="number" class="input-field" placeholder="b1">y = <input id="eq_c1" type="number" class="input-field" placeholder="c1"></div>
                        <div class="flex gap-2 items-center"><input id="eq_a2" type="number" class="input-field" placeholder="a2">x + <input id="eq_b2" type="number" class="input-field" placeholder="b2">y = <input id="eq_c2" type="number" class="input-field" placeholder="c2"></div>
                    </div>
                    <button onclick="solveSystemOfEquations()" class="calc-button">Resolver Sistema</button>
                    <div id="equationsResult" class="result-box hidden text-center"></div>
                </div>

                <div id="tool-percentage" class="tool-page">
                    <div class="flex items-center gap-2">
                        <input type="number" id="percentValue" class="input-field" placeholder="20">
                        <span class="font-bold text-lg">% de</span>
                        <input type="number" id="baseValue" class="input-field" placeholder="150">
                    </div>
                    <button onclick="calculatePercentage()" class="calc-button">Calcular</button>
                    <div id="percentageResult" class="result-box hidden text-center text-xl"></div>
                </div>

                <div id="tool-currency" class="tool-page">
                    <input type="number" id="amount" class="input-field" placeholder="Valor">
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <select id="from_currency" class="select-field"><option value="BRL">BRL (Real)</option><option value="USD">USD (D√≥lar)</option><option value="EUR">EUR (Euro)</option></select>
                        <select id="to_currency" class="select-field"><option value="USD">USD (D√≥lar)</option><option value="BRL">BRL (Real)</option><option value="EUR">EUR (Euro)</option></select>
                    </div>
                    <button onclick="convertCurrency()" class="calc-button">Converter</button>
                    <div id="currencyResult" class="result-box hidden text-center"></div>
                </div>

                <!-- NOVO CONVERSOR UNIVERSAL -->
                <div id="tool-measurement" class="tool-page">
                      <h2 class="text-center text-xl md:text-2xl font-bold mb-4 text-purple-400">Conversor Universal</h2>
                      <select id="measureCategory" class="select-field mb-4" onchange="updateMeasurementUnits()">
                          <option value="length">üìè Comprimento (m, km, mi...)</option>
                          <option value="mass">‚öñÔ∏è Massa (kg, lb, oz...)</option>
                          <option value="temperature">üå°Ô∏è Temperatura (C, F, K)</option>
                          <option value="volume">üíß Volume (l, gal, ml...)</option>
                          <option value="area">‚¨õ √Årea (m¬≤, ha, ac...)</option>
                      </select>
                      
                      <div class="flex gap-2 items-end">
                          <div class="flex-1">
                              <label class="text-xs text-gray-400">De:</label>
                              <input type="number" id="measurementAmount" class="input-field !mt-1" placeholder="Valor">
                              <select id="from_measurement" class="select-field !mt-1"></select>
                          </div>
                          <div class="pb-3 text-2xl text-gray-500">‚Üí</div>
                          <div class="flex-1">
                              <label class="text-xs text-gray-400">Para:</label>
                              <div class="h-[50px] flex items-end"><select id="to_measurement" class="select-field !mt-0"></select></div>
                          </div>
                      </div>
                      
                      <button onclick="convertMeasurement()" class="calc-button">Converter</button>
                      <div id="measurementResult" class="result-box hidden text-center text-xl flex items-center justify-center"></div>
                </div>

                <div id="tool-graph-plotter" class="tool-page">
                    <input type="text" id="functionInput" class="input-field" placeholder="Ex: x^2 ou sin(x)">
                    <div class="flex gap-2 mt-2">
                        <input type="number" id="xMin" class="input-field" value="-10" placeholder="Min">
                        <input type="number" id="xMax" class="input-field" value="10" placeholder="Max">
                    </div>
                    <button onclick="plotFunction()" class="calc-button">Plotar Gr√°fico</button>
                    <div class="bg-white rounded-lg mt-4 p-2">
                        <canvas id="functionChart"></canvas>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <footer class="bg-slate-900 text-gray-500 text-center py-8 border-t border-slate-800 mt-auto">
        <div class="max-w-4xl mx-auto px-4 mb-6">
            <h3 class="text-purple-400 font-bold mb-4 text-sm uppercase tracking-wider">Equipe de Desenvolvimento</h3>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 text-xs">
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Alicia Barbosa</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Alicy Monteiro</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Helen Vict√≥ria</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Helena Rodrigues</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Julia Gabrielly</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Julia Vitoria</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Kaio da Silva</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Kauanny Rodrigues</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Maria Eduarda</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Maria Helena</div>
                <div class="p-2 bg-slate-800/50 rounded border border-slate-700 hover:border-purple-500/30 transition">Vit√≥ria Regina</div>
            </div>
        </div>
        <p class="text-xs">&copy; 2025 INFINITY MIND's | Desenvolvido para Concenal</p>
    </footer>

    <script>
        // --- Tradu√ß√µes ---
        const translations = {
            'pt-br': {
                welcome_desc: "Ferramentas inteligentes para matem√°tica, ci√™ncias e organiza√ß√£o.",
                tool_basic_calc_title: "Calculadora B√°sica",
                tool_live_chat_title: "Tutor IA ao Vivo",
                tool_solve_by_photo_title: "Resolver por Foto",
                tool_bmi_title: "IMC + Nutri IA",
                gemini_error: "Erro na IA. Verifique a chave API.",
                back_to_menu: "Menu",
                tool_equations_title: "Sistemas Lineares",
                tool_quadratic_title: "Bhaskara (2¬∫ Grau)",
                tool_percentage_title: "Porcentagem",
                tool_graph_plotter_title: "Gr√°ficos",
                tool_measurement_title: "Conversor Universal",
                tool_word_problem_title: "Problemas L√≥gicos",
                tool_mind_map_title: "Mapa Mental",
                tool_summarizer_title: "Resumos",
                tool_level_explainer_title: "N√≠veis de Explica√ß√£o",
                tool_interactive_quiz_title: "Quiz Infinito",
                tool_image_gen_title: "Criar Imagens",
                tool_career_title: "Carreiras",
                tool_exercises_title: "Gerar Exerc√≠cios",
                tool_currency_title: "C√¢mbio",
                tool_math_story_title: "Hist√≥rias Matem√°ticas",
                tool_code_explainer_title: "Tutor de C√≥digo"
            },
            'en': {
                welcome_desc: "Smart tools for math, science and daily life.",
                tool_basic_calc_title: "Basic Calculator",
                tool_live_chat_title: "Live AI Tutor",
                tool_solve_by_photo_title: "Solve by Photo",
                tool_bmi_title: "BMI + AI Nutri",
                gemini_error: "AI Error. Check API Key.",
                back_to_menu: "Menu",
                tool_equations_title: "Linear Systems",
                tool_quadratic_title: "Quadratic Equation",
                tool_percentage_title: "Percentage",
                tool_graph_plotter_title: "Graphs",
                tool_measurement_title: "Universal Converter",
                tool_word_problem_title: "Logic Problems",
                tool_mind_map_title: "Mind Map",
                tool_summarizer_title: "Summaries",
                tool_level_explainer_title: "Explanation Levels",
                tool_interactive_quiz_title: "Infinite Quiz",
                tool_image_gen_title: "Create Images",
                tool_career_title: "Careers",
                tool_exercises_title: "Generate Exercises",
                tool_currency_title: "Currency",
                tool_math_story_title: "Math Stories",
                tool_code_explainer_title: "Code Tutor"
            },
            'es': {
                welcome_desc: "Herramientas inteligentes para matem√°ticas, ciencias y organizaci√≥n.",
                tool_basic_calc_title: "Calculadora B√°sica",
                tool_live_chat_title: "Tutor IA en Vivo",
                tool_solve_by_photo_title: "Resolver por Foto",
                tool_bmi_title: "IMC + Nutri IA",
                gemini_error: "Error de IA. Verifique clave API.",
                back_to_menu: "Men√∫",
                tool_equations_title: "Sistemas Lineales",
                tool_quadratic_title: "Ecuaci√≥n Cuadr√°tica",
                tool_percentage_title: "Porcentaje",
                tool_graph_plotter_title: "Gr√°ficos",
                tool_measurement_title: "Convertidor Universal",
                tool_word_problem_title: "Problemas L√≥gicos",
                tool_mind_map_title: "Mapa Mental",
                tool_summarizer_title: "Res√∫menes",
                tool_level_explainer_title: "Niveles de Explicaci√≥n",
                tool_interactive_quiz_title: "Quiz Infinito",
                tool_image_gen_title: "Crear Im√°genes",
                tool_career_title: "Carreras",
                tool_exercises_title: "Generar Ejercicios",
                tool_currency_title: "Cambio",
                tool_math_story_title: "Historias Matem√°ticas",
                tool_code_explainer_title: "Tutor de C√≥digo"
            },
            'it': {
                welcome_desc: "Strumenti intelligenti per matematica, scienze e organizzazione.",
                tool_basic_calc_title: "Calcolatrice Base",
                tool_live_chat_title: "Tutor IA dal Vivo",
                tool_solve_by_photo_title: "Risolvi con Foto",
                tool_bmi_title: "BMI + Nutri IA",
                gemini_error: "Errore IA. Controlla chiave API.",
                back_to_menu: "Menu",
                tool_equations_title: "Sistemi Lineari",
                tool_quadratic_title: "Equazione Quadratica",
                tool_percentage_title: "Percentuale",
                tool_graph_plotter_title: "Grafici",
                tool_measurement_title: "Convertitore Universale",
                tool_word_problem_title: "Problemi Logici",
                tool_mind_map_title: "Mappa Mentale",
                tool_summarizer_title: "Riassunti",
                tool_level_explainer_title: "Livelli di Spiegazione",
                tool_interactive_quiz_title: "Quiz Infinito",
                tool_image_gen_title: "Crea Immagini",
                tool_career_title: "Carriere",
                tool_exercises_title: "Genera Esercizi",
                tool_currency_title: "Cambio",
                tool_math_story_title: "Storie Matematiche",
                tool_code_explainer_title: "Tutor di Codice"
            },
            'de': {
                welcome_desc: "Intelligente Tools f√ºr Mathe, Wissenschaft und Organisation.",
                tool_basic_calc_title: "Basis-Rechner",
                tool_live_chat_title: "Live KI-Tutor",
                tool_solve_by_photo_title: "L√∂sen per Foto",
                tool_bmi_title: "BMI + KI Nutri",
                gemini_error: "KI-Fehler. API-Key pr√ºfen.",
                back_to_menu: "Men√º",
                tool_equations_title: "Lineare Systeme",
                tool_quadratic_title: "Quadratische Gleichung",
                tool_percentage_title: "Prozentsatz",
                tool_graph_plotter_title: "Grafiken",
                tool_measurement_title: "Universal-Konverter",
                tool_word_problem_title: "Logikprobleme",
                tool_mind_map_title: "Mind Map",
                tool_summarizer_title: "Zusammenfassungen",
                tool_level_explainer_title: "Erkl√§rungsstufen",
                tool_interactive_quiz_title: "Unendliches Quiz",
                tool_image_gen_title: "Bilder Erstellen",
                tool_career_title: "Karrieren",
                tool_exercises_title: "√úbungen Erstellen",
                tool_currency_title: "W√§hrung",
                tool_math_story_title: "Mathe-Geschichten",
                tool_code_explainer_title: "Code-Tutor"
            }
        };

        let currentLang = 'pt-br';
        function changeLanguage(lang) {
            currentLang = lang;
            const texts = translations[lang] || translations['pt-br'];
            document.querySelectorAll('[data-lang-key]').forEach(elem => {
                const key = elem.getAttribute('data-lang-key');
                if (texts[key]) elem.textContent = texts[key];
            });
            updateMeasurementUnits();
        }

        // --- Navega√ß√£o ---
        const homePage = document.getElementById('home-page');
        const toolsContainer = document.getElementById('tools-container');
        const toolTitle = document.getElementById('current-tool-title');

        function showTool(toolId) {
            homePage.style.display = 'none';
            toolsContainer.classList.remove('hidden');
            document.querySelectorAll('.tool-page').forEach(el => el.style.display = 'none');
            
            const activeTool = document.getElementById(toolId);
            if(activeTool) {
                activeTool.style.display = 'block';
                window.scrollTo(0,0);
                
                const titleKey = toolId + '_title';
                const translatedTitle = (translations[currentLang] && translations[currentLang][titleKey]) ? translations[currentLang][titleKey] : document.querySelector(`[onclick="showTool('${toolId}')"] h3`).textContent;
                toolTitle.textContent = translatedTitle;

                if(activeTool.classList.contains('ai-text-tool') && activeTool.childElementCount === 0) {
                    const promptPrefix = activeTool.dataset.prompt;
                    activeTool.innerHTML = `
                        <h2 class="text-xl md:text-2xl font-bold mb-4 text-purple-400 text-center">${toolTitle.textContent}</h2>
                        <textarea class="textarea-field h-32" placeholder="Digite aqui o que voc√™ precisa..."></textarea>
                        <button onclick="genericAICall(this, '${promptPrefix}')" class="calc-button gemini-button">Gerar Resposta com IA</button>
                        <div class="result-box hidden"></div>
                    `;
                }
            }
        }

        function showHome() {
            toolsContainer.classList.add('hidden');
            homePage.style.display = 'block';
        }

        // --- API Gemini ---
        function getApiKey() {
            let key = localStorage.getItem('geminiApiKey');
            if (!key) { showApiKeyModal(); return null; }
            return key;
        }

        function showApiKeyModal() { document.getElementById('apiKeyModal').classList.remove('hidden'); }
        function closeApiKeyModal() { document.getElementById('apiKeyModal').classList.add('hidden'); }
        function saveApiKeyFromModal() {
            const val = document.getElementById('modalApiKeyInput').value.trim();
            if(val) { localStorage.setItem('geminiApiKey', val); closeApiKeyModal(); alert("Conectado!"); }
        }

        async function callGeminiAPI(userPrompt, systemInstruction = null, isImage = false, imageData = null) {
            const apiKey = getApiKey();
            if (!apiKey) return null;

            const model = 'gemini-2.5-flash-preview-09-2025';
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            
            let payload = {
                contents: [{ parts: [] }],
                generationConfig: { temperature: 0.7, maxOutputTokens: 8192 } 
            };

            if (isImage && imageData) {
                 payload.contents[0].parts.push({ text: userPrompt });
                 payload.contents[0].parts.push({ inlineData: { mimeType: "image/jpeg", data: imageData } });
            } else {
                 payload.contents[0].parts.push({ text: userPrompt });
            }

            if (systemInstruction) {
                payload.systemInstruction = { parts: [{ text: systemInstruction }] };
            }

            const delays = [1000, 2000, 4000, 8000, 16000];
            let attempt = 0;

            while (true) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const status = response.status;
                        if (status === 503 || status === 429) {
                            throw new Error(`Overloaded or Rate Limited (${status})`);
                        }
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error?.message || response.statusText);
                    }

                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.candidates[0].content.parts[0].text;

                } catch (e) {
                    if (attempt < 5 && (e.message.includes('Overloaded') || e.message.includes('503') || e.message.includes('429') || e.message.includes('Failed to fetch'))) {
                        await new Promise(resolve => setTimeout(resolve, delays[attempt]));
                        attempt++;
                    } else {
                        console.error(e);
                        if (attempt >= 5) {
                            alert("O servidor da IA est√° sobrecarregado no momento. Tente novamente em alguns instantes.");
                        } else {
                            alert("Erro na IA: " + e.message);
                            if(e.message.includes('API key')) { localStorage.removeItem('geminiApiKey'); showApiKeyModal(); }
                        }
                        return null;
                    }
                }
            }
        }

        function cleanText(text) {
            if (!text) return "";
            return text
                .replace(/^###\s*(.*$)/gim, '<strong>$1</strong>') 
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
                .replace(/\*/g, '') 
                .replace(/\n/g, '<br>');
        }

        // --- DOWNLOAD PDF ---
        function downloadPDF(sourceElement, filename) {
            const contentClone = sourceElement.cloneNode(true);
            const buttons = contentClone.querySelectorAll('button');
            buttons.forEach(btn => btn.remove());

            contentClone.style.color = 'black';
            contentClone.style.background = 'transparent';
            contentClone.style.width = '100%';
            
            const allElements = contentClone.querySelectorAll('*');
            allElements.forEach(el => {
                el.style.color = '#000000';
                el.style.backgroundColor = 'transparent';
                el.style.borderColor = '#cccccc';
                el.classList.remove('text-white', 'text-gray-200', 'text-gray-300', 'text-gray-400', 'text-gray-500', 'bg-slate-800', 'bg-slate-900', 'bg-slate-700');
            });

            const pdfContainer = document.createElement('div');
            pdfContainer.style.width = '790px'; 
            pdfContainer.style.minHeight = '1000px';
            pdfContainer.style.padding = '40px';
            pdfContainer.style.backgroundColor = '#ffffff';
            pdfContainer.style.fontFamily = 'Arial, sans-serif';
            pdfContainer.style.border = '1px solid #ddd';
            
            pdfContainer.style.position = 'fixed';
            pdfContainer.style.top = '0';
            pdfContainer.style.left = '0';
            pdfContainer.style.zIndex = '-9999';
            pdfContainer.style.pointerEvents = 'none'; 

            const watermark = document.createElement('div');
            watermark.innerHTML = "INFINITY MIND's";
            watermark.style.cssText = `
                position: absolute; top: 50%; left: 50%; 
                transform: translate(-50%, -50%) rotate(-45deg); 
                font-size: 90px; font-weight: bold; color: #f5f5f5; 
                z-index: 0; pointer-events: none; user-select: none;
                white-space: nowrap;
            `;
            pdfContainer.appendChild(watermark);

            const contentWrapper = document.createElement('div');
            contentWrapper.style.position = 'relative';
            contentWrapper.style.zIndex = '1';

            const header = document.createElement('div');
            header.innerHTML = `
                <div style="text-align: center; border-bottom: 3px solid #7C3AED; padding-bottom: 20px; margin-bottom: 30px;">
                    <h1 style="color: #7C3AED; font-size: 28px; margin: 0; font-weight: bold; letter-spacing: 1px;">INFINITY MIND's</h1>
                    <p style="font-size: 14px; color: #666; margin-top: 5px; font-style: italic;">Prof. Kelvin - Sistema Educacional</p>
                </div>
            `;
            contentWrapper.appendChild(header);
            contentWrapper.appendChild(contentClone);

            const footer = document.createElement('div');
            footer.innerHTML = `
                <div style="margin-top: 60px; text-align: center; font-size: 10px; color: #888; border-top: 1px solid #eee; padding-top: 15px;">
                    Documento gerado em ${new Date().toLocaleString('pt-BR')} ‚Ä¢ INFINITY MIND's v2.0
                </div>
            `;
            contentWrapper.appendChild(footer);

            pdfContainer.appendChild(contentWrapper);
            document.body.appendChild(pdfContainer);

            const opt = {
                margin: [15, 15, 15, 15],
                filename: filename + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            setTimeout(() => {
                html2pdf().set(opt).from(pdfContainer).save().then(() => {
                    document.body.removeChild(pdfContainer);
                }).catch(err => {
                    console.error("Erro PDF:", err);
                    alert("Erro ao gerar PDF. Tente novamente.");
                    document.body.removeChild(pdfContainer);
                });
            }, 500); 
        }

        function downloadChatPDF() {
            const chatWindow = document.getElementById('chatWindow');
            if (!chatWindow.innerText.trim()) return alert("O chat est√° vazio.");
            downloadPDF(chatWindow, 'Chat_Tutor_InfinityMinds');
        }

        // --- Chat IA com BLOQUEIO ---
        const politicalWords = ['lula', 'bolsonaro', 'pt', 'pl', 'pol√≠tica', 'voto', 'elei√ß√£o', 'partido', 'governo'];
        const offensiveWords = ['sexo', 'porn', 'matar', 'suicidio', 'puta', 'puto', 'buceta', 'penis', 'gostosa', 'cachorra', 'cachorro', 'gostoso', 'pau', 'pica', 'caralho', 'merda', 'bosta', 'foder', 'transar', 'cu', 'viado'];

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim().toLowerCase();
            const originalMsg = input.value.trim();
            const chatWindow = document.getElementById('chatWindow');
            const lockoutMessage = document.getElementById('lockout-message');
            const style = document.getElementById('responseStyle').value;

            // 1. Verificar se h√° bloqueio ativo
            const banUntil = localStorage.getItem('chatBanUntil');
            if (banUntil && Date.now() < parseInt(banUntil)) {
                const remaining = Math.ceil((parseInt(banUntil) - Date.now()) / 60000);
                lockoutMessage.textContent = `üö´ Acesso suspenso temporariamente. Volte em ${remaining} minutos.`;
                lockoutMessage.classList.remove('hidden');
                return;
            } else {
                lockoutMessage.classList.add('hidden');
            }

            if(!originalMsg) return;

            // 2. Verificar Pol√≠tica (72h)
            if (politicalWords.some(w => msg.includes(w))) {
                const banTime = Date.now() + (72 * 60 * 60 * 1000); // 72 horas
                localStorage.setItem('chatBanUntil', banTime);
                chatWindow.innerHTML += `<div class="chat-bubble bg-red-900/50 text-white border border-red-500 self-center text-center">üõë <strong>Assunto Proibido:</strong> Discuss√µes pol√≠ticas n√£o s√£o permitidas. Seu acesso ao chat foi suspenso por 72 horas.</div>`;
                input.value = '';
                return;
            }

            // 3. Verificar Ofensas (Progressivo)
            if (offensiveWords.some(w => msg.includes(w))) {
                let offenses = parseInt(localStorage.getItem('chatOffenses') || '0') + 1;
                localStorage.setItem('chatOffenses', offenses);
                
                let banDuration = 0;
                let msgText = "";

                if (offenses === 1) {
                    banDuration = 15 * 60 * 1000; // 15 min
                    msgText = "15 minutos";
                } else {
                    banDuration = 24 * 60 * 60 * 1000; // 24 horas
                    msgText = "24 horas";
                }

                const banTime = Date.now() + banDuration;
                localStorage.setItem('chatBanUntil', banTime);

                chatWindow.innerHTML += `<div class="chat-bubble bg-red-900/50 text-white border border-red-500 self-center text-center">‚ö†Ô∏è <strong>Linguagem Inadequada:</strong> (${offenses}¬™ infra√ß√£o). Seu acesso foi suspenso por ${msgText}. Mantenha o respeito.</div>`;
                input.value = '';
                return;
            }

            // Se passou, envia mensagem
            chatWindow.innerHTML += `<div class="chat-bubble chat-user">${originalMsg}</div>`;
            input.value = '';
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const loadId = 'load-' + Date.now();
            chatWindow.innerHTML += `<div id="${loadId}" class="chat-bubble chat-ai"><div class="loader" style="border-color:#8B5CF6; border-bottom-color:transparent"></div> Digitando...</div>`;
            chatWindow.scrollTop = chatWindow.scrollHeight;

            const systemP = `Voc√™ √© o "Tutor Infinity", um professor de ensino fundamental/m√©dio amig√°vel, especialista em exatas. Estilo: ${style}. Use LaTeX ($...$) para f√≥rmulas. Responda em ${currentLang}.`;

            const text = await callGeminiAPI(originalMsg, systemP);
            
            document.getElementById(loadId).remove();
            
            if(text) {
                const formatted = cleanText(text);
                chatWindow.innerHTML += `<div class="chat-bubble chat-ai">${formatted}</div>`;
                if(window.MathJax) window.MathJax.typesetPromise([chatWindow]);
            } else {
                chatWindow.innerHTML += `<div class="chat-bubble chat-ai text-red-400">Erro de conex√£o.</div>`;
            }
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // --- EXERC√çCIOS (NOVA FUN√á√ÉO) ---
        async function generateExercises() {
            const topic = document.getElementById('exTopic').value;
            const grade = document.getElementById('exGrade').value;
            const diff = document.getElementById('exDiff').value;
            const type = document.getElementById('exType').value;
            const resDiv = document.getElementById('exResult');

            if(!topic) return alert("Por favor, digite um assunto.");

            resDiv.classList.remove('hidden');
            resDiv.innerHTML = '<div class="loader"></div> <span class="animate-pulse">A IA est√° criando sua lista personalizada...</span>';

            const prompt = `
                Atue como um professor de matem√°tica do ensino fundamental (Brasil).
                Crie uma lista de 5 exerc√≠cios sobre "${topic}".
                P√∫blico: Alunos do ${grade}.
                N√≠vel: ${diff}.
                Formato: ${type}.
                
                Estrutura Obrigat√≥ria:
                1. T√≠tulo da Lista (com cabe√ßalho escolar)
                2. As 5 Quest√µes (numeradas)
                3. Espa√ßo para resposta (se dissertativa) ou op√ß√µes A,B,C,D (se m√∫ltipla escolha)
                4. GABARITO COMENTADO no final.
                
                Use LaTeX para f√≥rmulas matem√°ticas.
            `;

            const text = await callGeminiAPI(prompt);
            if(text) {
                resDiv.innerHTML = cleanText(text);
                if(window.MathJax) window.MathJax.typesetPromise([resDiv]);
                
                const btnId = 'dl-ex-' + Date.now();
                resDiv.innerHTML += `<br><button id="${btnId}" class="mt-4 bg-slate-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-slate-600 transition shadow-lg w-full md:w-auto justify-center">üì• Baixar Lista de Exerc√≠cios (PDF)</button>`;
                setTimeout(() => {
                    document.getElementById(btnId).onclick = () => downloadPDF(resDiv, `Exercicios_${topic.replace(/\s/g,'_')}`);
                }, 100);
            } else {
                resDiv.innerHTML = "Erro ao gerar exerc√≠cios.";
            }
        }

        // --- CARREIRA MELHORADA (NOVA FUN√á√ÉO) ---
        async function generateCareerPlan() {
            const interest = document.getElementById('careerInterest').value;
            const skills = document.getElementById('careerSkills').value;
            const level = document.getElementById('careerLevel').value;
            const resDiv = document.getElementById('careerResult');

            if(!interest || !skills) return alert("Por favor, preencha seus interesses e habilidades.");

            resDiv.classList.remove('hidden');
            resDiv.innerHTML = '<div class="loader"></div> <span class="animate-pulse">A IA est√° montando seu plano de futuro...</span>';

            const prompt = `
                Crie um plano de carreira detalhado para um estudante do n√≠vel: ${level}.
                Interesse Principal: ${interest}.
                Habilidades Atuais: ${skills}.
                
                A resposta deve conter:
                1. **Caminho de Estudos:** O que focar agora na escola/faculdade.
                2. **Habilidades a Desenvolver:** O que aprender extra.
                3. **Poss√≠veis Profiss√µes:** 3 op√ß√µes de carreira relacionadas.
                4. **Dica de Ouro:** Um conselho pr√°tico.
                
                Use formata√ß√£o clara com t√≥picos. Idioma: Portugu√™s do Brasil.
            `;

            const text = await callGeminiAPI(prompt);
            if(text) {
                resDiv.innerHTML = cleanText(text);
                const btnId = 'dl-career-' + Date.now();
                resDiv.innerHTML += `<br><button id="${btnId}" class="mt-4 bg-slate-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-slate-600 transition shadow-lg w-full md:w-auto justify-center">üì• Baixar Plano de Carreira</button>`;
                setTimeout(() => {
                    document.getElementById(btnId).onclick = () => downloadPDF(resDiv, 'Plano_Carreira_InfinityMinds');
                }, 100);
            } else {
                resDiv.innerHTML = "Erro ao gerar plano.";
            }
        }

        // --- Conversor Universal Completo (Abrasileirado) ---
        const unitFactors = {
            length: { m: 1, km: 1000, cm: 0.01, mm: 0.001, mi: 1609.34, yd: 0.9144, ft: 0.3048, in: 0.0254 },
            mass: { kg: 1, g: 0.001, mg: 0.000001, lb: 0.453592, oz: 0.0283495 },
            volume: { l: 1, ml: 0.001, gal: 3.78541, floz: 0.0295735 },
            area: { sq_m: 1, sq_km: 1000000, ha: 10000, ac: 4046.86, sq_ft: 0.092903 },
            temperature: { c: 'c', f: 'f', k: 'k' } 
        };

        function updateMeasurementUnits() {
             const cat = document.getElementById('measureCategory').value;
             const sel1 = document.getElementById('from_measurement');
             const sel2 = document.getElementById('to_measurement');
             
             sel1.innerHTML = sel2.innerHTML = '';
             
             const units = Object.keys(unitFactors[cat]);
             units.forEach(u => {
                 let label = u.toUpperCase();
                 if (u === 'sq_m') label = 'm¬≤';
                 if (u === 'sq_km') label = 'km¬≤';
                 if (u === 'sq_ft') label = 'ft¬≤';
                 if (u === 'in') label = 'pol';
                 
                 sel1.innerHTML += `<option value="${u}">${label}</option>`;
                 sel2.innerHTML += `<option value="${u}">${label}</option>`;
             });
        }

        function convertMeasurement() {
             const cat = document.getElementById('measureCategory').value;
             const val = parseFloat(document.getElementById('measurementAmount').value);
             const from = document.getElementById('from_measurement').value;
             const to = document.getElementById('to_measurement').value;
             const resDiv = document.getElementById('measurementResult');

             if (isNaN(val)) return;
             resDiv.classList.remove('hidden');

             let result;

             if (cat === 'temperature') {
                 let tempInC;
                 if (from === 'c') tempInC = val;
                 else if (from === 'f') tempInC = (val - 32) * 5/9;
                 else if (from === 'k') tempInC = val - 273.15;

                 if (to === 'c') result = tempInC;
                 else if (to === 'f') result = (tempInC * 9/5) + 32;
                 else if (to === 'k') result = tempInC + 273.15;
             } else {
                 const baseVal = val * unitFactors[cat][from];
                 result = baseVal / unitFactors[cat][to];
             }

             // Formata√ß√£o Brasileira
             const formattedResult = result.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
             const formattedVal = val.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
             
             // Ajuste do Label
             let toLabel = to.toUpperCase();
             let fromLabel = from.toUpperCase();
             if(to === 'sq_m') toLabel = 'm¬≤'; if(from === 'sq_m') fromLabel = 'm¬≤';

             resDiv.innerHTML = `<strong>${formattedVal} ${fromLabel} = ${formattedResult} ${toLabel}</strong>`;
        }

        // ... (Outras fun√ß√µes inalteradas: genericAICall, solveByPhoto, generateImage, etc.) ...
        // ... Apenas garantindo que genericAICall e outras usem cleanText e downloadPDF se necess√°rio ...

        // --- Ferramentas Gen√©ricas IA (Mantidas) ---
        async function genericAICall(btn, prefix) {
            const textarea = btn.previousElementSibling;
            const input = textarea.value;
            const resultDiv = btn.nextElementSibling;
            
            if(!input.trim()) return;
            
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = '<div class="loader border-purple-500"></div> Gerando resposta...';

            const system = `Assistente educacional expert. Responda estruturado e did√°tico. Idioma: ${currentLang}`;
            const fullPrompt = `${prefix} "${input}"`;

            const text = await callGeminiAPI(fullPrompt, system);
            
            if(text) {
                resultDiv.innerHTML = cleanText(text);
                if(window.MathJax) window.MathJax.typesetPromise([resultDiv]);
                
                const btnId = 'dl-btn-' + Date.now();
                resultDiv.innerHTML += `<br><button id="${btnId}" class="mt-4 bg-slate-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-slate-600 transition shadow-lg w-full md:w-auto justify-center">üì• Baixar PDF</button>`;
                setTimeout(() => {
                    const dlBtn = document.getElementById(btnId);
                    if(dlBtn) dlBtn.onclick = () => downloadPDF(resultDiv, 'InfinityMinds_Resultado');
                }, 100);

            } else {
                resultDiv.innerHTML = "Erro ao processar.";
            }
        }

        // Vis√£o, ImagemGen, CalcBasics, Bhaskara, Percent, Cambio, Plotter, Quiz, MindMap, IMC 
        // (Mantidos do bloco anterior, apenas garantindo que est√£o aqui)
        
        let currentImgBase64 = null;
        function previewImage(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                document.getElementById('image-preview').src = evt.target.result;
                document.getElementById('image-preview').classList.remove('hidden');
                document.getElementById('solveByPhotoBtn').classList.remove('hidden');
                currentImgBase64 = evt.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }
        async function solveByPhoto() {
            if(!currentImgBase64) return;
            const resDiv = document.getElementById('solveByPhotoResult');
            resDiv.classList.remove('hidden');
            resDiv.innerHTML = '<div class="loader"></div> Analisando imagem...';
            const system = `Solucionador matem√°tico. Analise e resolva passo a passo. Idioma: ${currentLang}`;
            const text = await callGeminiAPI("Resolva este problema.", system, true, currentImgBase64);
            if(text) {
                resDiv.innerHTML = cleanText(text);
                if(window.MathJax) window.MathJax.typesetPromise([resDiv]);
                const btnId = 'dl-photo-' + Date.now();
                resDiv.innerHTML += `<br><button id="${btnId}" class="mt-4 bg-slate-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2 hover:bg-slate-600 transition shadow-lg w-full md:w-auto justify-center">üì• Baixar Resolu√ß√£o</button>`;
                setTimeout(() => { document.getElementById(btnId).onclick = () => downloadPDF(resDiv, 'Resolucao_Foto'); }, 100);
            } else { resDiv.innerHTML = "N√£o consegui ler a imagem."; }
        }
        async function generateImage() {
            const prompt = document.getElementById('imagePrompt').value;
            const resDiv = document.getElementById('imageResult');
            if(!prompt) return;
            resDiv.innerHTML = '<div class="loader"></div>';
            const apiKey = getApiKey();
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ instances: [{ prompt: prompt }], parameters: { sampleCount: 1 } })
                });
                const data = await response.json();
                if(data.predictions && data.predictions[0]) {
                    const b64 = data.predictions[0].bytesBase64Encoded;
                    resDiv.innerHTML = `<img src="data:image/png;base64,${b64}" class="rounded shadow-lg max-h-[400px]">`;
                } else { throw new Error("Modelo indispon√≠vel."); }
            } catch(e) { resDiv.innerHTML = `<p class="text-yellow-400 text-sm">Erro: ${e.message}</p>`; }
        }
        let calcDisplay = document.getElementById('basicCalcDisplay');
        function appendToDisplay(v) { calcDisplay.value += v; }
        function clearDisplay() { calcDisplay.value = ''; }
        function calculateResult() { try { calcDisplay.value = eval(calcDisplay.value); } catch { calcDisplay.value = 'Erro'; } }
        function solveQuadratic() {
            const a = parseFloat(document.getElementById('coeffA').value);
            const b = parseFloat(document.getElementById('coeffB').value);
            const c = parseFloat(document.getElementById('coeffC').value);
            const div = document.getElementById('quadraticResult');
            const btnEx = document.getElementById('quadraticExplainBtn');
            div.classList.remove('hidden');
            if(isNaN(a) || isNaN(b) || isNaN(c)) return div.innerHTML = "Preencha a, b e c";
            const delta = b*b - 4*a*c;
            let html = `Œî = ${delta}<br>`;
            if(delta < 0) { html += "N√£o h√° ra√≠zes reais."; } else {
                const x1 = (-b + Math.sqrt(delta))/(2*a);
                const x2 = (-b - Math.sqrt(delta))/(2*a);
                html += `<strong>x1 = ${x1.toFixed(2)}</strong><br><strong>x2 = ${x2.toFixed(2)}</strong>`;
            }
            div.innerHTML = html;
            btnEx.classList.remove('hidden');
        }
        function explainQuadraticSteps() {
            const a = document.getElementById('coeffA').value;
            const b = document.getElementById('coeffB').value;
            const c = document.getElementById('coeffC').value;
            const div = document.getElementById('quadraticExplainResult');
            div.classList.remove('hidden');
            div.innerHTML = "<div class='loader'></div>";
            callGeminiAPI(`Explique a equa√ß√£o ${a}x¬≤ + ${b}x + ${c} = 0. Idioma: ${currentLang}`).then(t => {
                div.innerHTML = cleanText(t);
                const btnId = 'dl-quad-' + Date.now();
                div.innerHTML += `<br><button id="${btnId}" class="mt-3 bg-slate-700 text-white px-3 py-1 rounded text-xs">üì• Baixar Explica√ß√£o</button>`;
                setTimeout(() => { document.getElementById(btnId).onclick = () => downloadPDF(div, 'Bhaskara_Explicacao'); }, 100);
            });
        }
        function calculatePercentage() {
            const pInput = document.getElementById('percentValue').value;
            const bInput = document.getElementById('baseValue').value;
            const div = document.getElementById('percentageResult');
            const p = parseFloat(pInput.replace(',', '.'));
            const b = parseFloat(bInput.replace(',', '.'));
            div.classList.remove('hidden');
            if(isNaN(p) || isNaN(b)) { div.innerHTML = "Valores inv√°lidos"; return; }
            const res = (p/100) * b;
            div.innerHTML = `<strong>${p}% de ${b} = ${res.toFixed(2)}</strong>`;
        }
        async function convertCurrency() {
            const amount = parseFloat(document.getElementById('amount').value);
            const from = document.getElementById('from_currency').value;
            const to = document.getElementById('to_currency').value;
            const div = document.getElementById('currencyResult');
            if(!amount) return alert("Digite um valor.");
            div.classList.remove('hidden');
            div.innerHTML = '<div class="loader"></div>';
            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${from}`);
                const data = await response.json();
                const rate = data.rates[to];
                const result = (amount * rate).toFixed(2);
                div.innerHTML = `<strong>${amount} ${from} = ${result} ${to}</strong>`;
            } catch(e) { div.innerHTML = "Erro na convers√£o."; }
        }
        function plotFunction() {
            const expr = document.getElementById('functionInput').value;
            const ctx = document.getElementById('functionChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            const xValues = [];
            const yValues = [];
            try {
                for(let x = -10; x <= 10; x+=0.5) {
                    xValues.push(x);
                    let scope = {x: x};
                    yValues.push(math.evaluate(expr, scope));
                }
                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: xValues, datasets: [{ label: `f(x) = ${expr}`, data: yValues, borderColor: '#8B5CF6', tension: 0.2 }] }
                });
            } catch(e) { alert("Fun√ß√£o inv√°lida."); }
        }
        async function startQuiz() {
            const topic = document.getElementById('quizTopic').value || "Conhecimentos Gerais";
            document.getElementById('quiz-setup').classList.add('hidden');
            document.getElementById('quiz-game').classList.remove('hidden');
            loadQuizQuestion(topic);
        }
        async function loadQuizQuestion(topic) {
            const container = document.getElementById('quiz-question-container');
            document.getElementById('quiz-loader').classList.remove('hidden');
            document.getElementById('quiz-content').classList.add('hidden');
            const jsonSchema = `{ "question": "Texto", "options": ["A","B","C","D"], "answer": 0, "explanation": "Texto" }`;
            const system = `JSON pergunta quiz sobre "${topic}". Formato: ${jsonSchema}. Idioma: ${currentLang}`;
            const text = await callGeminiAPI("Gerar", system);
            try {
                const jsonStr = text.replace(/```json|```/g, '').trim();
                const data = JSON.parse(jsonStr);
                document.getElementById('quiz-question-text').textContent = data.question;
                const optsDiv = document.getElementById('quiz-options');
                optsDiv.innerHTML = '';
                data.options.forEach((opt, idx) => {
                    optsDiv.innerHTML += `<button class="p-3 bg-slate-700 hover:bg-slate-600 rounded text-left transition" onclick="checkQuiz(this, ${idx}, ${data.answer}, '${data.explanation}')">${opt}</button>`;
                });
                document.getElementById('quiz-loader').classList.add('hidden');
                document.getElementById('quiz-content').classList.remove('hidden');
                document.getElementById('quiz-feedback').classList.add('hidden');
                document.getElementById('quiz-next-btn').classList.add('hidden');
            } catch(e) {
                alert("Erro no quiz. Tente novamente.");
                document.getElementById('quiz-setup').classList.remove('hidden');
                document.getElementById('quiz-game').classList.add('hidden');
            }
        }
        function checkQuiz(btn, selected, correct, explain) {
            const parent = document.getElementById('quiz-options');
            const feedback = document.getElementById('quiz-feedback');
            Array.from(parent.children).forEach((b, i) => {
                b.disabled = true;
                if(i === correct) b.classList.add('bg-green-600', 'text-white');
                else if(i === selected) b.classList.add('bg-red-600', 'text-white');
            });
            feedback.innerHTML = selected === correct ? `<strong class="text-green-400">Correto!</strong> ${explain}` : `<strong class="text-red-400">Errado.</strong> ${explain}`;
            feedback.className = selected === correct ? "mt-4 p-4 rounded-lg text-sm border border-green-500 bg-green-900/20 block" : "mt-4 p-4 rounded-lg text-sm border border-red-500 bg-red-900/20 block";
            document.getElementById('quiz-next-btn').classList.remove('hidden');
            if(selected === correct) {
                let score = document.getElementById('quiz-score');
                score.innerText = "Pontos: " + (parseInt(score.innerText.split(' ')[1]) + 10);
            }
        }
        function nextQuizQuestion() { loadQuizQuestion(document.getElementById('quizTopic').value || "Geral"); }
        async function generateMindMap() {
            const subject = document.getElementById('mindMapSubject').value;
            if(!subject) return;
            const container = document.getElementById('mindMapContainer');
            container.innerHTML = '<div class="loader"></div>';
            const system = `Mapa mental JSON: { "center": "Tema", "nodes": ["Sub1", "Sub2", "Sub3", "Sub4"] }. Tema: "${subject}". Idioma: ${currentLang}`;
            const text = await callGeminiAPI("Gerar", system);
            try {
                const data = JSON.parse(text.replace(/```json|```/g, '').trim());
                container.innerHTML = `
                <svg width="100%" height="100%" viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
                    <line x1="300" y1="200" x2="150" y2="100" stroke="#475569" stroke-width="2"/>
                    <line x1="300" y1="200" x2="450" y2="100" stroke="#475569" stroke-width="2"/>
                    <line x1="300" y1="200" x2="150" y2="300" stroke="#475569" stroke-width="2"/>
                    <line x1="300" y1="200" x2="450" y2="300" stroke="#475569" stroke-width="2"/>
                    <circle cx="300" cy="200" r="50" fill="#8B5CF6" />
                    <text x="300" y="205" text-anchor="middle" fill="white" font-weight="bold" font-size="14">${data.center.substring(0,15)}</text>
                    <rect x="100" y="80" width="100" height="40" rx="10" fill="#10B981" />
                    <text x="150" y="105" text-anchor="middle" fill="white" font-size="12">${data.nodes[0]}</text>
                    <rect x="400" y="80" width="100" height="40" rx="10" fill="#10B981" />
                    <text x="450" y="105" text-anchor="middle" fill="white" font-size="12">${data.nodes[1]}</text>
                    <rect x="100" y="280" width="100" height="40" rx="10" fill="#10B981" />
                    <text x="150" y="305" text-anchor="middle" fill="white" font-size="12">${data.nodes[2]}</text>
                    <rect x="400" y="280" width="100" height="40" rx="10" fill="#10B981" />
                    <text x="450" y="305" text-anchor="middle" fill="white" font-size="12">${data.nodes[3]}</text>
                </svg>`;
            } catch(e) { container.innerHTML = "Erro visual."; }
        }
        function solveSystemOfEquations() {
             const a1 = parseFloat(document.getElementById('eq_a1').value);
             const b1 = parseFloat(document.getElementById('eq_b1').value);
             const c1 = parseFloat(document.getElementById('eq_c1').value);
             const a2 = parseFloat(document.getElementById('eq_a2').value);
             const b2 = parseFloat(document.getElementById('eq_b2').value);
             const c2 = parseFloat(document.getElementById('eq_c2').value);
             const div = document.getElementById('equationsResult');
             div.classList.remove('hidden');
             const det = a1*b2 - a2*b1;
             if(det === 0) { div.innerHTML = "Sistema sem solu√ß√£o √∫nica (D=0)"; } else {
                 const x = (c1*b2 - c2*b1)/det;
                 const y = (a1*c2 - a2*c1)/det;
                 div.innerHTML = `x = ${x.toFixed(2)} <br> y = ${y.toFixed(2)}`;
             }
        }

        // --- NOVO: IMC com IA Integrada ---
        async function calculateBMI() {
            const w = parseFloat(document.getElementById('weight').value);
            const h = parseFloat(document.getElementById('height').value);
            const resDiv = document.getElementById('bmiResult');
            const valDiv = document.getElementById('bmiValue');
            const catDiv = document.getElementById('bmiCategory');
            const aiDiv = document.getElementById('bmiAiContent');
            const bar = document.getElementById('bmiBar');

            if(!w || !h) return alert("Preencha peso e altura");

            const hM = h / 100;
            const bmi = w / (hM * hM);
            const bmiFixed = bmi.toFixed(1);

            // L√≥gica Classifica√ß√£o
            let cat = "";
            let colorClass = "";
            let percent = 0;

            if(bmi < 18.5) { cat = "Abaixo do Peso"; colorClass = "text-yellow-400"; percent = 20; }
            else if(bmi < 24.9) { cat = "Peso Normal"; colorClass = "text-green-400"; percent = 50; }
            else if(bmi < 29.9) { cat = "Sobrepeso"; colorClass = "text-orange-400"; percent = 75; }
            else { cat = "Obesidade"; colorClass = "text-red-500"; percent = 100; }

            // Atualiza UI
            resDiv.classList.remove('hidden');
            valDiv.innerText = bmiFixed;
            catDiv.innerText = cat;
            catDiv.className = `text-xl font-medium ${colorClass}`;
            setTimeout(() => { bar.style.width = percent + "%"; }, 100);

            // CHAMADA IA AUTOM√ÅTICA
            aiDiv.innerHTML = '<div class="flex items-center gap-2"><div class="loader" style="width:16px;height:16px;"></div> <span class="animate-pulse">A IA est√° analisando seu perfil...</span></div>';
            
            const systemPrompt = "Voc√™ √© um nutricionista esportivo encorajador e pr√°tico.";
            const userPrompt = `O usu√°rio tem um IMC de ${bmiFixed} classificado como ${cat}. Crie 3 dicas curtas (bullet points) e sugira 1 refei√ß√£o espec√≠fica saud√°vel para este caso. Seja direto. Idioma: ${currentLang}`;

            const aiResponse = await callGeminiAPI(userPrompt, systemPrompt);
            if(aiResponse) {
                aiDiv.innerHTML = cleanText(aiResponse);
                // Adiciona bot√£o download espec√≠fico para o resultado do IMC
                const btnId = 'dl-bmi-' + Date.now();
                aiDiv.innerHTML += `<br><button id="${btnId}" class="mt-3 text-xs text-pink-400 border border-pink-500/50 px-2 py-1 rounded hover:bg-pink-500/20 transition">üì• Baixar Dicas</button>`;
                document.getElementById(btnId).onclick = () => downloadPDF(aiDiv, 'Dicas_Saude_InfinityMinds');
            } else {
                aiDiv.innerHTML = "N√£o foi poss√≠vel gerar dicas agora.";
            }
        }

        updateMeasurementUnits();
    </script>
</body>
</html>
